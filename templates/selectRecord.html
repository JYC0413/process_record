<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Selection & Download</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 40px;
            position: relative;
            z-index: 10;
        }

        .header-container {
            position: relative;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 设置按钮样式 */
        .settings-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            color: #fff;
            transform: translateY(-50%) rotate(30deg);
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #1f1f3f 0%, #1a1a2e 100%);
            margin: 10% auto;
            padding: 30px;
            width: 80%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-header {
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #fff;
        }

        .success-message {
            background: rgba(39, 174, 96, 0.2);
            border-left: 4px solid #27ae60;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
        }

        .section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .section:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .section-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
        }

        .tab-container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 30px;
            display: flex;
            gap: 8px;
        }

        .tab-btn-header, .tab-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            position: relative;
        }

        .tab-btn-header:hover, .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
        }

        .tab-btn-header.active, .tab-btn.active {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        input[type="datetime-local"] {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="datetime-local"]:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        /* 加载动画 */
        .loader {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #workflowResult {
            display: none;
            margin-top: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
        }

        textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
            min-height: 120px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .section {
                padding: 20px;
            }

            .btn {
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1>Meeting Audio Processing</h1>
            <div style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); display: flex; gap: 10px;">
                <button id="settingsBtn" class="settings-btn" title="Settings">⚙️</button>
            </div>
        </div>

        <!-- 设置模态框 -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="close-modal">&times;</span>
                    <h2>Settings</h2>
                </div>
                <div class="modal-body">
                    <form id="settingsForm">
                        <div class="form-group">
                            <label>Whisper API URL:</label>
                            <input type="text" id="whisperApiUrl" name="whisper_api_url" placeholder="https://whisper.gaia.domains/v1/audio/transcriptions" style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                        </div>
                        <div class="form-group">
                            <label>Whisper API Key:</label>
                            <input type="password" id="whisperApiKey" name="whisper_api_key" placeholder="Enter API Key" style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                        </div>
                        <div class="btn-container">
                            <button type="submit" class="btn" id="saveSettingsBtn">Save Settings</button>
                            <div class="loader" id="settingsLoader" style="display:none;"></div>
                        </div>
                    </form>
                    <div id="settingsSaved" class="success-message">
                        Settings saved successfully! Changes will apply to all new requests.
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-container">
            <button class="tab-btn-header active" onclick="openTab(event, 'downloadTab')">
                <span class="tab-icon">🎧</span>
                Download Audio
            </button>
            <button class="tab-btn-header" onclick="openTab(event, 'workflowTab')">
                <span class="tab-icon">🔄</span>
                Send to Workflow
            </button>
        </div>

        <div id="downloadTab" class="tab-content active">
            <div class="section">
                <div class="section-header">
                    <div class="section-icon">📥</div>
                    <h2>Select Time Range for Audio Download</h2>
                </div>
                <form id="downloadForm" method="post" action="/download">
                    <div class="form-group">
                        <label>Start Time:</label>
                        <input type="datetime-local" name="start_time" required step="1">
                    </div>
                    <div class="form-group">
                        <label>End Time:</label>
                        <input type="datetime-local" name="end_time" required step="1">
                    </div>
                    <div class="btn-container">
                        <button type="submit" class="btn">Download Merged Audio</button>
                        <div class="loader" id="downloadLoader"></div>
                    </div>
                </form>
            </div>
        </div>

        <div id="workflowTab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <div class="section-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">🔄</div>
                    <h2>Send Merged Audio to Workflow</h2>
                </div>
                <form id="workflowForm" method="post">
                    <div class="form-group">
                        <label>Start Time:</label>
                        <input type="datetime-local" name="start_time" required step="1">
                    </div>
                    <div class="form-group">
                        <label>End Time:</label>
                        <input type="datetime-local" name="end_time" required step="1">
                    </div>

                    <!-- 处理类型选择 -->
                    <div class="form-group">
                        <label>Processing Type:</label>
                        <div class="tab-container" style="margin-bottom:15px;">
                            <button type="button" class="tab-btn active" id="processAudio">
                                <span class="tab-icon">🔊</span>
                                Process Audio Directly
                            </button>
                            <button type="button" class="tab-btn" id="processText">
                                <span class="tab-icon">📝</span>
                                Process Transcript
                            </button>
                        </div>
                    </div>

                    <!-- 音频处理流程 (默认显示) -->
                    <div id="audioProcessSection">
                        <div class="form-group">
                            <label for="audioWorkflowSelect">Select Audio Workflow:</label>
                            <select id="audioWorkflowSelect" name="selected_workflow" style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                                <option value="">-- Select a workflow --</option>
                            </select>
                            <div id="audioWorkflowDescription" style="margin-top:8px;font-size:0.9rem;color:#b0b0b0;"></div>
                        </div>

                        <!-- 自定义API URL (音频) -->
                        <div id="audioApiUrlSection" style="display:none;">
                            <div class="form-group">
                                <label for="audioApiUrl">API URL:</label>
                                <input type="text" id="audioApiUrl" name="audio_api_url" placeholder="http://your-api/handle" style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                            </div>
                            <!-- 添加API Key输入字段 -->
                            <div class="form-group">
                                <label for="audioApiKey">API Key (optional):</label>
                                <input type="text" id="audioApiKey" name="audio_api_key" placeholder="Your API Key" style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                            </div>
                        </div>

                        <div class="btn-container">
                            <button type="button" class="btn" id="btnStartAudioWorkflow">Start Audio Processing</button>
                            <div class="loader" id="audioProcessLoader" style="display:none;"></div>
                        </div>
                    </div>

                    <!-- 文本处理流程 (默认隐藏) -->
                    <div id="textProcessSection" style="display:none;">
                        <div class="form-group" id="transcribeStatusSection">
                            <!-- 添加语言选择下拉菜单 -->
                            <div class="form-group">
                                <label for="languageSelect">Recognition Language:</label>
                                <select id="languageSelect" name="language" style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                                    <option value="auto">Auto-detect (Default)</option>
                                    <option value="zh">Chinese (中文)</option>
                                    <option value="en">English</option>
                                    <option value="es">Spanish (Español)</option>
                                    <option value="fr">French (Français)</option>
                                    <option value="de">German (Deutsch)</option>
                                    <option value="ja">Japanese (日本語)</option>
                                    <option value="ko">Korean (한국어)</option>
                                    <option value="ru">Russian (Русский)</option>
                                    <option value="pt">Portuguese (Português)</option>
                                    <option value="ar">Arabic (العربية)</option>
                                    <option value="hi">Hindi (हिन्दी)</option>
                                    <option value="it">Italian (Italiano)</option>
                                </select>
                            </div>
                            <div class="btn-container">
                                <button type="button" class="btn" id="btnStartTranscription">Start Transcription</button>
                            </div>
                        </div>

                        <!-- 转录结果部分 (开始隐藏) -->
                        <div id="transcribeResultSection" style="display:none;">
                            <div class="form-group">
                                <label for="transcribeTextarea">Recognition Result (editable):</label>
                                <textarea id="transcribeTextarea" name="transcript" style="min-height:120px;"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="textWorkflowSelect">Select Text Workflow:</label>
                                <select id="textWorkflowSelect" name="selected_workflow" style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                                    <option value="">-- Select a workflow --</option>
                                </select>
                                <div id="textWorkflowDescription" style="margin-top:8px;font-size:0.9rem;color:#b0b0b0;"></div>
                            </div>

                            <!-- 自定义API URL (文本) -->
                            <div id="textApiUrlSection" style="display:none;">
                                <div class="form-group">
                                    <label for="textApiUrl">API URL:</label>
                                    <input type="text" id="textApiUrl" name="text_api_url" placeholder="http://your-api/handle" style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                                </div>
                                <!-- 添加API Key输入字段 -->
                                <div class="form-group">
                                    <label for="textApiKey">API Key (optional):</label>
                                    <input type="text" id="textApiKey" name="text_api_key" placeholder="Your API Key" style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                                </div>
                            </div>

                            <!-- 自定义提示词部分 -->
                            <div id="customPromptSection" style="display:none;">
                                <div class="form-group">
                                    <label for="customPrompt">Custom Prompt:</label>
                                    <textarea name="custom_prompt" id="customPrompt" placeholder="Enter a custom prompt for the AI..."></textarea>
                                </div>
                            </div>

                            <div class="btn-container">
                                <button type="button" class="btn" id="btnStartTextWorkflow">Process Text</button>
                                <div class="loader" id="textProcessLoader" style="display:none;"></div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="input_type" id="inputTypeField" value="audio">
                </form>

                <!-- 进度条和结果显示部分 -->
                <div id="workflowProgressBar" style="display:none;margin-top:20px;">
                    <div style="background:#222;border-radius:8px;overflow:hidden;">
                        <div id="workflowProgressInner" style="height:18px;width:0%;background:linear-gradient(90deg,#667eea,#764ba2);transition:width 0.3s;"></div>
                    </div>
                    <ul id="workflowSteps" style="margin-top:10px;font-size:14px;list-style:none;padding-left:0;"></ul>
                </div>
                <div id="workflowResult"></div>
            </div>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // 按钮禁用/启用函数
        function disableButton(btn, loadingText = null) {
            btn.disabled = true;
            btn.dataset.originalHtml = btn.innerHTML;
            if (loadingText) {
                btn.innerHTML = `<span class="loading-spinner"></span> ${loadingText}`;
            }
            btn.style.opacity = '0.7';
            btn.style.cursor = 'not-allowed';
        }

        function enableButton(btn) {
            btn.disabled = false;
            if (btn.dataset.originalHtml) {
                btn.innerHTML = btn.dataset.originalHtml;
            }
            btn.style.opacity = '';
            btn.style.cursor = '';
        }

        // 设置模态框功能
        document.addEventListener('DOMContentLoaded', function() {
            // 获取模态框元素
            const modal = document.getElementById('settingsModal');
            const btn = document.getElementById('settingsBtn');
            const closeBtn = document.querySelector('.close-modal');
            const settingsForm = document.getElementById('settingsForm');
            const settingsSaved = document.getElementById('settingsSaved');
            const whisperApiUrl = document.getElementById('whisperApiUrl');
            const whisperApiKey = document.getElementById('whisperApiKey');

            // 当用户点击设置按钮时，打开模态框
            btn.onclick = function() {
                // 打开模态框前加载当前设置
                disableButton(btn);
                loadCurrentSettings();
                modal.style.display = "block";
                enableButton(btn);
            }

            // 当用户点击 X 按钮时，关闭模态框
            closeBtn.onclick = function() {
                modal.style.display = "none";
                // 隐藏成功消息
                settingsSaved.style.display = "none";
            }

            // 当用户点击模态框外部时，关闭模态框
            window.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = "none";
                    // 隐藏成功消息
                    settingsSaved.style.display = "none";
                }
            }

            // 加载当前设置
            function loadCurrentSettings() {
                fetch('/get_config')
                    .then(response => response.json())
                    .then(data => {
                        const whisperConfig = data.whisper_api || {};
                        whisperApiUrl.value = whisperConfig.url || "";
                        whisperApiKey.value = whisperConfig.api_key || "";
                    })
                    .catch(error => {
                        console.error('Error loading settings:', error);
                    });
            }

            // 保存设置
            settingsForm.onsubmit = function(e) {
                e.preventDefault();

                // 禁用保存按钮
                const saveBtn = document.getElementById('saveSettingsBtn');
                disableButton(saveBtn, 'Saving...');

                const updatedConfig = {
                    whisper_api: {
                        url: whisperApiUrl.value.trim() || "https://whisper.gaia.domains/v1/audio/transcriptions",
                        api_key: whisperApiKey.value.trim() || ""
                    }
                };

                fetch('/update_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedConfig)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        // 显示成功消息
                        settingsSaved.style.display = "block";

                        // 3秒后自动隐藏成功消息
                        setTimeout(() => {
                            settingsSaved.style.display = "none";
                        }, 3000);
                    } else {
                        alert("Failed to save settings: " + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error saving settings:', error);
                    alert("An error occurred while saving settings");
                })
                .finally(() => {
                    // 重新启用保存按钮
                    enableButton(saveBtn);
                });
            }
        });

        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-btn-header");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            // 在切换标签页时同步时间选择器
            if (tabName === "downloadTab") {
                // 从工作流标签页复制时间到下载标签页
                const workflowStartTime = document.querySelector('#workflowTab input[name="start_time"]').value;
                const workflowEndTime = document.querySelector('#workflowTab input[name="end_time"]').value;
                document.querySelector('#downloadTab input[name="start_time"]').value = workflowStartTime;
                document.querySelector('#downloadTab input[name="end_time"]').value = workflowEndTime;
            } else if (tabName === "workflowTab") {
                // 从下载标签页复制时间到工作流标签页
                const downloadStartTime = document.querySelector('#downloadTab input[name="start_time"]').value;
                const downloadEndTime = document.querySelector('#downloadTab input[name="end_time"]').value;
                document.querySelector('#workflowTab input[name="start_time"]').value = downloadStartTime;
                document.querySelector('#workflowTab input[name="end_time"]').value = downloadEndTime;
            }
        }

        // 设置处理类型切换按钮的事件处理程序
        document.addEventListener('DOMContentLoaded', function() {
            // 处理类型切换
            document.getElementById('processAudio').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('processAudio').classList.add('active');
                document.getElementById('processText').classList.remove('active');
                document.getElementById('audioProcessSection').style.display = '';
                document.getElementById('textProcessSection').style.display = 'none';
                document.getElementById('inputTypeField').value = 'audio';
            });

            document.getElementById('processText').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('processText').classList.add('active');
                document.getElementById('processAudio').classList.remove('active');
                document.getElementById('audioProcessSection').style.display = 'none';
                document.getElementById('textProcessSection').style.display = '';
                document.getElementById('inputTypeField').value = 'text';
            });

            // 加载工作流列表
            fetch('/get_workflows')
                .then(response => response.json())
                .then(data => {
                    const workflows = data.workflows || [];
                    const audioWorkflowSelect = document.getElementById('audioWorkflowSelect');
                    const textWorkflowSelect = document.getElementById('textWorkflowSelect');

                    // 清空现有选项
                    audioWorkflowSelect.innerHTML = '<option value="">-- Select a workflow --</option>';
                    textWorkflowSelect.innerHTML = '<option value="">-- Select a workflow --</option>';

                    // 分类添加工作流选项
                    workflows.forEach(workflow => {
                        const option = document.createElement('option');
                        option.value = workflow.name;
                        option.textContent = workflow.name;
                        option.dataset.description = workflow.description || '';
                        option.dataset.apiEndpoint = workflow.api_endpoint || '';
                        option.dataset.apiKey = workflow.api_key || '';
                        option.dataset.inputType = workflow.input_type || 'text';
                        option.dataset.customPrompt = workflow.custom_prompt || '';

                        // 根据工作流类型添加到不同的选择器
                        if (workflow.input_type === 'audio') {
                            audioWorkflowSelect.appendChild(option.cloneNode(true));
                        } else {
                            textWorkflowSelect.appendChild(option.cloneNode(true));
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading workflows:', error);
                });

            // 监听音频工作流选择变化
            document.getElementById('audioWorkflowSelect').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const description = selectedOption.dataset.description || '';
                const apiEndpoint = selectedOption.dataset.apiEndpoint || '';

                // 显示工作流描述
                document.getElementById('audioWorkflowDescription').textContent = description;

                // 处理自定义API输入框
                const audioApiUrlSection = document.getElementById('audioApiUrlSection');
                if (selectedOption.value.includes('Custom API')) {
                    audioApiUrlSection.style.display = '';
                    document.getElementById('audioApiUrl').value = apiEndpoint;
                    document.getElementById('audioApiKey').value = ''; // 清空API Key
                } else {
                    audioApiUrlSection.style.display = 'none';
                }
            });

            // 监听文本工作流选择变化
            document.getElementById('textWorkflowSelect').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const description = selectedOption.dataset.description || '';
                const apiEndpoint = selectedOption.dataset.apiEndpoint || '';
                const customPrompt = selectedOption.dataset.customPrompt || '';

                // 显示工作流描述
                document.getElementById('textWorkflowDescription').textContent = description;

                // 处理自定义API输入框和自定义提示词输入框
                const textApiUrlSection = document.getElementById('textApiUrlSection');
                const customPromptSection = document.getElementById('customPromptSection');

                if (selectedOption.value.includes('Custom API')) {
                    textApiUrlSection.style.display = '';
                    customPromptSection.style.display = 'none';
                    document.getElementById('textApiUrl').value = apiEndpoint;
                    document.getElementById('textApiKey').value = ''; // 清空API Key
                } else if (selectedOption.value.includes('Summary') || selectedOption.value.includes('Chat') || customPrompt) {
                    textApiUrlSection.style.display = 'none';
                    customPromptSection.style.display = '';
                    document.getElementById('customPrompt').value = customPrompt || "You are a professional meeting assistant. Please summarize the following meeting transcript. Your summary should be clear, concise, and well-structured.";
                } else {
                    textApiUrlSection.style.display = 'none';
                    customPromptSection.style.display = 'none';
                }
            });

            // 开始转录按钮事件
            document.getElementById('btnStartTranscription').addEventListener('click', function() {
                disableButton(this, 'Transcription...');
                startTranscription(this);
            });

            // 音频处理按钮事件
            document.getElementById('btnStartAudioWorkflow').addEventListener('click', function() {
                disableButton(this, 'Processing...');
                startAudioWorkflow(this);
            });

            // 文本处理按钮事件
            document.getElementById('btnStartTextWorkflow').addEventListener('click', function() {
                disableButton(this, 'Processing...');
                startTextWorkflow(this);
            });
        });

        // 开始转录流程 - 使用新的/transcribe接口
        function startTranscription(btn) {
            resetWorkflowUI();

            const form = document.getElementById('workflowForm');
            const startTime = form.querySelector('input[name="start_time"]').value;
            const endTime = form.querySelector('input[name="end_time"]').value;
            const selectedLanguage = form.querySelector('#languageSelect').value;

            if (!startTime || !endTime) {
                alert('Please select both start and end times.');
                enableButton(btn);
                return;
            }

            document.getElementById('workflowProgressBar').style.display = '';

            const formData = new FormData();
            formData.set('start_time', toUTCString(startTime));
            formData.set('end_time', toUTCString(endTime));
            formData.set('language', selectedLanguage);

            const socket = io();
            let steps = [];
            let currentStep = 0;

            fetch('/transcribe', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(!data || !data.task_id) {
                    if(data && data.message) {
                        alert("Failed to start transcription: " + data.message);
                    } else {
                        alert("Failed to start transcription: Unknown error");
                    }
                    enableButton(btn);
                    return;
                }
                const taskId = data.task_id;

                socket.on('workflow_progress', function(msg) {
                    if (!msg || msg.task_id !== taskId) return;

                    steps.push(msg.message);
                    currentStep++;
                    updateProgressBar(steps, currentStep);

                    if (msg.step === 'done') {
                        // 转录完成，显示结果
                        document.getElementById('transcribeTextarea').value = msg.result || '';
                        document.getElementById('transcribeResultSection').style.display = '';
                        document.getElementById('transcribeStatusSection').style.display = 'none';
                        document.getElementById('workflowProgressBar').style.display = 'none';
                        socket.disconnect();
                        enableButton(btn);
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Transcription failed: ' + error);
                document.getElementById('workflowProgressBar').style.display = 'none';
                enableButton(btn);
            });
        }

        // 开始音频处理工作流 - 使用新的/process_workflow接口
        function startAudioWorkflow(btn) {
            resetWorkflowUI();

            const form = document.getElementById('workflowForm');
            const startTime = form.querySelector('input[name="start_time"]').value;
            const endTime = form.querySelector('input[name="end_time"]').value;
            const selectedWorkflow = document.getElementById('audioWorkflowSelect').value;

            if (!startTime || !endTime) {
                alert('Please select both start and end times.');
                enableButton(btn);
                return;
            }

            if (!selectedWorkflow) {
                alert('Please select a workflow.');
                enableButton(btn);
                return;
            }

            const formData = new FormData();
            formData.set('start_time', toUTCString(startTime));
            formData.set('end_time', toUTCString(endTime));
            formData.set('selected_workflow', selectedWorkflow);
            formData.set('input_type', 'audio');

            if (selectedWorkflow.includes('Custom API')) {
                const apiUrl = document.getElementById('audioApiUrl').value;
                const apiKey = document.getElementById('audioApiKey').value;

                if (!apiUrl) {
                    alert('Please enter an API URL for the custom API workflow.');
                    enableButton(btn);
                    return;
                }
                formData.set('audio_api_url', apiUrl);
                if (apiKey) {
                    formData.set('audio_api_key', apiKey);
                }
            }

            // 直接使用同步请求处理工作流
            fetch('/process_workflow', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('workflowResult').style.display = 'block';
                renderWorkflowResult(data.result || data);
                enableButton(btn);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('workflowResult').innerText = "Request failed: " + error;
                document.getElementById('workflowResult').style.display = 'block';
                enableButton(btn);
            });
        }

        // 开始文本处理工作流 - 使用新的/process_workflow接口
        function startTextWorkflow(btn) {
            resetWorkflowUI();

            const form = document.getElementById('workflowForm');
            const startTime = form.querySelector('input[name="start_time"]').value;
            const endTime = form.querySelector('input[name="end_time"]').value;
            const selectedWorkflow = document.getElementById('textWorkflowSelect').value;
            const transcript = document.getElementById('transcribeTextarea').value;

            if (!startTime || !endTime) {
                alert('Please select both start and end times.');
                enableButton(btn);
                return;
            }

            if (!selectedWorkflow) {
                alert('Please select a workflow.');
                enableButton(btn);
                return;
            }

            if (!transcript) {
                alert('Transcript is empty. Please run transcription first.');
                enableButton(btn);
                return;
            }

            const formData = new FormData();
            formData.set('start_time', toUTCString(startTime));
            formData.set('end_time', toUTCString(endTime));
            formData.set('selected_workflow', selectedWorkflow);
            formData.set('transcript', transcript);
            formData.set('input_type', 'text');

            if (selectedWorkflow.includes('Custom API')) {
                const apiUrl = document.getElementById('textApiUrl').value;
                const apiKey = document.getElementById('textApiKey').value;

                if (!apiUrl) {
                    alert('Please enter an API URL for the custom API workflow.');
                    enableButton(btn);
                    return;
                }
                formData.set('text_api_url', apiUrl);
                if (apiKey) {
                    formData.set('text_api_key', apiKey);
                }
            } else if (document.getElementById('customPromptSection').style.display !== 'none') {
                const customPrompt = document.getElementById('customPrompt').value;
                if (customPrompt) {
                    formData.set('custom_prompt', customPrompt);
                }
            }

            // 直接使用同步请求处理工作流
            fetch('/process_workflow', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('workflowResult').style.display = 'block';
                renderWorkflowResult(data.result || data);
                enableButton(btn);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('workflowResult').innerText = "Request failed: " + error;
                document.getElementById('workflowResult').style.display = 'block';
                enableButton(btn);
            });
        }

        // 更新进度条
        function updateProgressBar(steps, currentStep) {
            let totalSteps = Math.max(5, currentStep + 2);
            let percent = Math.min(100, Math.round((currentStep / totalSteps) * 100));
            document.getElementById('workflowProgressInner').style.width = percent + '%';

            const ul = document.getElementById('workflowSteps');
            ul.innerHTML = '';
            steps.forEach((step) => {
                ul.innerHTML += `<li style="margin-bottom:4px;">${step}</li>`;
            });
        }

        // 重置工作流UI
        function resetWorkflowUI() {
            document.getElementById('workflowResult').style.display = 'none';
            document.getElementById('workflowResult').innerHTML = '';
            document.getElementById('workflowProgressBar').style.display = 'none';
            document.getElementById('workflowProgressInner').style.width = '0%';
            document.getElementById('workflowSteps').innerHTML = '';
        }

        // 渲染工作流结果
        function renderWorkflowResult(result) {
            const container = document.getElementById('workflowResult');
            container.innerHTML = '';
            if (!result) return;

            if (typeof result === 'string') {
                // 链接
                if (/^https?:\/\/.+/.test(result)) {
                    if (/\.(mp3|wav|ogg)$/i.test(result)) {
                        container.innerHTML = `<audio controls src="${result}" style="width:100%"></audio>`;
                    } else if (/\.(mp4|webm|mov)$/i.test(result)) {
                        container.innerHTML = `<video controls src="${result}" style="width:100%"></video>`;
                    } else {
                        container.innerHTML = `<a href="${result}" target="_blank">${result}</a>`;
                    }
                } else {
                    container.innerText = result;
                }
            } else if (result && result.type && result.url) {
                // 后端返回结构化类型
                if (result.type === 'audio') {
                    container.innerHTML = `<audio controls src="${result.url}" style="width:100%"></audio>`;
                } else if (result.type === 'video') {
                    container.innerHTML = `<video controls src="${result.url}" style="width:100%"></video>`;
                } else if (result.type === 'link') {
                    container.innerHTML = `<a href="${result.url}" target="_blank">${result.url}</a>`;
                } else {
                    container.innerText = result.content || JSON.stringify(result);
                }
            } else {
                container.innerText = typeof result === 'object' ? JSON.stringify(result) : result;
            }
        }

        // 格式化时间
        function toUTCString(localStr) {
            const date = new Date(localStr);
            return date.getUTCFullYear() + '-' +
                String(date.getUTCMonth() + 1).padStart(2, '0') + '-' +
                String(date.getUTCDate()).padStart(2, '0') + 'T' +
                String(date.getUTCHours()).padStart(2, '0') + ':' +
                String(date.getUTCMinutes()).padStart(2, '0') + ':' +
                String(date.getUTCSeconds()).padStart(2, '0');
        }

        function toLocalISOString(date) {
            const pad = n => String(n).padStart(2, '0');
            const year = date.getFullYear();
            const month = pad(date.getMonth() + 1);
            const day = pad(date.getDate());
            const hours = pad(date.getHours());
            const minutes = pad(date.getMinutes());
            const seconds = pad(date.getSeconds());

            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        }

        // 设置默认时间范围
        window.onload = function() {
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            const oneHourLater = new Date(now.getTime());
            const startTimeInputs = document.querySelectorAll('input[name="start_time"]');
            const endTimeInputs = document.querySelectorAll('input[name="end_time"]');

            startTimeInputs.forEach(input => {
                input.value = toLocalISOString(oneHourAgo);
            });

            endTimeInputs.forEach(input => {
                input.value = toLocalISOString(oneHourLater);
            });
        }

        // 保留与下载相关的表单处理
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('downloadForm').onsubmit = async function(e) {
                e.preventDefault();

                // 禁用下载按钮
                const downloadBtn = this.querySelector('button[type="submit"]');
                disableButton(downloadBtn, 'Downloading...');

                const form = this;
                const startInput = form.querySelector('input[name="start_time"]');
                const endInput = form.querySelector('input[name="end_time"]');

                const formData = new FormData();
                formData.append('start_time', toUTCString(startInput.value));
                formData.append('end_time', toUTCString(endInput.value));

                try {
                    const resp = await fetch('/download', {
                        method: 'POST',
                        body: formData
                    });

                    if (resp.ok) {
                        const blob = await resp.blob();
                        // 尝试从header获取文件名
                        let filename = 'audio.wav';
                        const disposition = resp.headers.get('Content-Disposition');
                        if (disposition && disposition.indexOf('filename=') !== -1) {
                            filename = decodeURIComponent(disposition.split('filename=')[1].replace(/['"]/g, ''));
                        }
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);
                    } else {
                        console.log(resp)
                        const data = await resp.json();
                        alert('下载失败: ' + (data.message || '未知错误'));
                    }
                } catch (err) {
                    alert('请求出错: ' + err.message);
                } finally {
                    enableButton(downloadBtn);
                }
            }
        });
    </script>
</body>
</html>
