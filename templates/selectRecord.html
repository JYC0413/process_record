<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Selection & Download</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 40px;
            position: relative;
            z-index: 10;
        }

        .header-container {
            position: relative;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 时间切换开关样式 */
        .time-toggle-container {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .time-format {
            font-weight: 600;
        }

        .time-format-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 设置按钮样式 */
        .settings-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            color: #fff;
            transform: translateY(-50%) rotate(30deg);
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #1f1f3f 0%, #1a1a2e 100%);
            margin: 10% auto;
            padding: 30px;
            width: 80%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-header {
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #fff;
        }

        .success-message {
            background: rgba(39, 174, 96, 0.2);
            border-left: 4px solid #27ae60;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
        }

        .section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1000;
        }

        .section:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .section-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
        }

        .tab-container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 30px;
            display: flex;
            gap: 8px;
        }

        .tab-btn-header, .tab-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            position: relative;
        }

        .tab-btn-header:hover, .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
        }

        .tab-btn-header.active, .tab-btn.active {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            position: relative;
            z-index: 1;
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        input[type="datetime-local"] {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="datetime-local"]:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        /* 加载动画 */
        .loader {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #workflowResult {
            display: none;
            margin-top: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
        }

        textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
            min-height: 120px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .section {
                padding: 20px;
            }

            .btn {
                padding: 10px 20px;
            }
        }

        /* 搜索框下拉菜单样式 */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding-right: 40px; /* 为下拉箭头留空间 */
        }

        .dropdown-arrow {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: #1f1f3f;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .dropdown-list.show {
            display: block;
        }

        /* 文件夹列表样式 */
        .folder-list {
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
        }

        .folder-item {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .folder-item:last-child {
            border-bottom: none;
        }

        .folder-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .folder-item.selected {
            background: rgba(102, 126, 234, 0.2);
            border-left: 4px solid #667eea;
        }

        .folder-name {
            font-weight: 500;
        }

        .folder-info {
            font-size: 0.8rem;
            color: #b0b0b0;
        }

        .folder-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
        }

        /* 聊天界面样式 */
        .chat-message {
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            max-width: 80%;
        }

        .user-message {
            background: rgba(102, 126, 234, 0.15);
            margin-left: auto;
            border-top-right-radius: 2px;
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.05);
            margin-right: auto;
            border-top-left-radius: 2px;
        }

        .message-time {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
            text-align: right;
        }

        #sendMessage {
            transition: all 0.3s;
        }

        #sendMessage:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            padding: 10px 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 10px;
            width: fit-content;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            background: #667eea;
            display: block;
            margin: 0 2px;
            opacity: 0.4;
        }

        .typing-indicator span:nth-child(1) {
            animation: bounce 1s infinite 0.1s;
        }

        .typing-indicator span:nth-child(2) {
            animation: bounce 1s infinite 0.3s;
        }

        .typing-indicator span:nth-child(3) {
            animation: bounce 1s infinite 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* 说话人编辑弹窗样式 */
        .speaker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow: auto;
        }

        .speaker-modal-content {
            background: linear-gradient(135deg, #1f1f3f 0%, #1a1a2e 100%);
            margin: 5% auto;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .speaker-item {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .speaker-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .speaker-name-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            padding: 8px 12px;
            font-size: 1rem;
            width: 250px;
        }

        .utterance-item {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            position: relative;
        }

        .utterance-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .utterance-text {
            color: #fff;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .play-audio-btn {
            background: rgba(102, 126, 234, 0.2);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 10px;
            transition: all 0.2s;
        }

        .play-audio-btn:hover {
            background: rgba(102, 126, 234, 0.4);
        }

        .show-more-btn {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .show-more-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .save-speakers-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 10px 25px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto 0;
        }

        .save-speakers-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .edit-speakers-btn {
            background: rgba(102, 126, 234, 0.2);
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .edit-speakers-btn:hover {
            background: rgba(102, 126, 234, 0.4);
        }

        /* 音频播放器样式 */
        .audio-player {
            width: 100%;
            height: 30px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header-container">
        <!-- 添加时间格式切换开关 -->
        <div class="time-toggle-container">
            <span class="time-format time-format-local time-format-active">LOCAL</span>
            <label class="toggle-switch">
                <input type="checkbox" id="timeFormatToggle">
                <span class="toggle-slider"></span>
            </label>
            <span class="time-format time-format-utc">UTC</span>
        </div>

        <h1>Meeting Audio Processing</h1>
        <div style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); display: flex; gap: 10px;">
            <button onclick="window.open('/config','_blank')" class="settings-btn" title="Settings">⚙️</button>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab-btn-header active" onclick="openTab(event, 'workflowTab')">
            <span class="tab-icon">🔄</span>
            Workflow
        </button>
        <button class="tab-btn-header" onclick="openTab(event, 'downloadTab')">
            <span class="tab-icon">🎧</span>
            Download Audio
        </button>
    </div>

    <!-- 新增：文件夹选择部分 -->
    <div class="section">
        <div class="section-header">
            <div class="section-icon">📁</div>
            <h2>Select Recording Folder</h2>
        </div>
        <div class="form-group">
            <div class="search-container">
                <input type="text" id="folderSearchInput" class="search-input" placeholder="Search or select a folder"
                       style="width:100%;padding:12px 16px;padding-right:40px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                <span class="dropdown-arrow">▼</span>
                <div id="folderDropdown" class="dropdown-list">
                    <div class="dropdown-item" data-folder-path="" data-start-time="" data-end-time="">All Folders</div>
                    <!-- Folders will be loaded here -->
                </div>
            </div>
        </div>
        <div id="selectedFolderInfo" style="margin-top: 10px; font-size: 0.9rem; color: #b0b0b0; display: none;">
            <!-- Selected folder info will be shown here -->
        </div>
    </div>

    <div id="downloadTab" class="tab-content">
        <div class="section">
            <div class="section-header">
                <div class="section-icon">📥</div>
                <h2>Select Time Range for Audio Download</h2>
            </div>
            <form id="downloadForm" method="post" action="/download">
                <div class="form-group">
                    <label>Start Time:</label>
                    <input type="datetime-local" name="start_time" required step="1">
                </div>
                <div class="form-group">
                    <label>End Time:</label>
                    <input type="datetime-local" name="end_time" required step="1">
                </div>
                <!-- 添加隐藏的文件夹路径输入 -->
                <input type="hidden" name="folder_path" id="downloadFolderPath" value="">
                <div class="btn-container">
                    <button type="submit" class="btn">Download Merged Audio</button>
                    <div class="loader" id="downloadLoader"></div>
                </div>
            </form>
        </div>
    </div>

    <div id="workflowTab" class="tab-content active">
        <div class="section">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">🔄</div>
                <h2>Send Merged Audio to Workflow</h2>
            </div>
            <form id="workflowForm" method="post">
                <div class="form-group">
                    <label>Start Time:</label>
                    <input type="datetime-local" name="start_time" required step="1">
                </div>
                <div class="form-group">
                    <label>End Time:</label>
                    <input type="datetime-local" name="end_time" required step="1">
                </div>
                <!-- 添加隐藏的文件夹路径输入 -->
                <input type="hidden" name="folder_path" id="workflowFolderPath" value="">

                <!-- 处理类型选择 -->
                <div class="form-group">
                    <label>Processing Type:</label>
                    <div class="tab-container" style="margin-bottom:15px;">
                        <button type="button" class="tab-btn active" id="processText">
                            <span class="tab-icon">📝</span>
                            Transcribe and process text
                        </button>
                        <button type="button" class="tab-btn" id="processAudio">
                            <span class="tab-icon">🔊</span>
                            Process audio
                        </button>
                    </div>
                </div>

                <!-- 音频处理流程 (默认显示) -->
                <div id="audioProcessSection" style="display:none;">
                    <div class="form-group">
                        <label for="audioWorkflowSelect">Select Audio Workflow:</label>
                        <select id="audioWorkflowSelect" name="selected_workflow"
                                style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                            <option value="">-- Select a workflow --</option>
                        </select>
                        <div id="audioWorkflowDescription" style="margin-top:8px;font-size:0.9rem;color:#b0b0b0;"></div>
                    </div>

                    <!-- 自定义API URL (音频) -->
                    <div id="audioApiUrlSection" style="display:none;">
                        <div class="form-group">
                            <label for="audioApiUrl">API URL:</label>
                            <input type="text" id="audioApiUrl" name="audio_api_url"
                                   placeholder="http://your-api/handle"
                                   style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                        </div>
                        <!-- 添加API Key输入字段 -->
                        <div class="form-group">
                            <label for="audioApiKey">API Key (optional):</label>
                            <input type="text" id="audioApiKey" name="audio_api_key" placeholder="Your API Key"
                                   style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                        </div>
                    </div>

                    <div class="btn-container">
                        <button type="button" class="btn" id="btnStartAudioWorkflow">Start Audio Processing</button>
                        <div class="loader" id="audioProcessLoader" style="display:none;"></div>
                    </div>
                </div>

                <!-- 文本处理流程 (默认隐藏) -->
                <div id="textProcessSection">
                    <div class="form-group" id="transcribeStatusSection">
                        <!-- 添加语言选择下拉菜单 -->
                        <div class="form-group">
                            <label for="languageSelect">Recognition Language:</label>
                            <select id="languageSelect" name="language"
                                    style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                                <option value="auto">Auto-detect (Default)</option>
                                <option value="zh">Chinese (中文)</option>
                                <option value="en">English</option>
                                <option value="es">Spanish (Español)</option>
                                <option value="fr">French (Français)</option>
                                <option value="de">German (Deutsch)</option>
                                <option value="ja">Japanese (日本語)</option>
                                <option value="ko">Korean (한국어)</option>
                                <option value="ru">Russian (Русский)</option>
                                <option value="pt">Portuguese (Português)</option>
                                <option value="ar">Arabic (العربية)</option>
                                <option value="hi">Hindi (हिन्दी)</option>
                                <option value="it">Italian (Italiano)</option>
                            </select>
                        </div>
                        <!-- 新增说话人数输入框 -->
                        <div class="form-group">
                            <label for="speakersNumInput">Number of Speakers (optional):</label>
                            <input type="number" id="speakersNumInput" name="speakers_num" min="0" placeholder="Leave blank if unknown"
                                   style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                        </div>
                        <div class="btn-container">
                            <button type="button" class="btn" id="btnStartTranscription">Start Transcription</button>
                        </div>
                    </div>

                    <!-- 转录结果部分 (开始隐藏) -->
                    <div id="transcribeResultSection" style="display:none;">
                        <div class="form-group">
                            <label for="transcribeTextarea">Recognition Result (editable):</label>
                            <textarea id="transcribeTextarea" name="transcript" style="min-height:120px;"></textarea>
                            <button type="button" id="editSpeakersBtn" class="edit-speakers-btn">
                                <span>👤</span> Edit Speakers
                            </button>
                        </div>

                        <div class="form-group">
                            <label for="textWorkflowSelect">Select Text Workflow:</label>
                            <select id="textWorkflowSelect" name="selected_workflow"
                                    style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                                <option value="">-- Select a workflow --</option>
                            </select>
                            <div id="textWorkflowDescription"
                                 style="margin-top:8px;font-size:0.9rem;color:#b0b0b0;"></div>
                        </div>

                        <!-- 自定义API URL (文本) -->
                        <div id="textApiUrlSection" style="display:none;">
                            <div class="form-group">
                                <label for="textApiUrl">API URL:</label>
                                <input type="text" id="textApiUrl" name="text_api_url"
                                       placeholder="http://your-api/handle"
                                       style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                            </div>
                            <!-- 添加API Key输入字段 -->
                            <div class="form-group">
                                <label for="textApiKey">API Key (optional):</label>
                                <input type="text" id="textApiKey" name="text_api_key" placeholder="Your API Key"
                                       style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                            </div>
                        </div>

                        <!-- 自定义提示词部分 -->
                        <div id="customPromptSection" style="display:none;">
                            <div class="form-group">
                                <label for="customPrompt">Custom Prompt:</label>
                                <textarea name="custom_prompt" id="customPrompt"
                                          placeholder="Enter a custom prompt for the AI..."></textarea>
                            </div>
                        </div>

                        <div class="btn-container">
                            <button type="button" class="btn" id="btnStartTextWorkflow">Process Text</button>
                            <div class="loader" id="textProcessLoader" style="display:none;"></div>
                        </div>
                    </div>
                </div>

                <input type="hidden" name="input_type" id="inputTypeField" value="audio">
            </form>

            <!-- 进度条和结果显示部分 -->
            <div id="workflowProgressBar" style="display:none;margin-top:20px;">
                <div style="background:#222;border-radius:8px;overflow:hidden;">
                    <div id="workflowProgressInner"
                         style="height:18px;width:0%;background:linear-gradient(90deg,#667eea,#764ba2);transition:width 0.3s;"></div>
                </div>
                <ul id="workflowSteps" style="margin-top:10px;font-size:14px;list-style:none;padding-left:0;"></ul>
            </div>
            <div id="workflowResult"></div>

            <!-- 添加聊天界面 -->
            <div id="chatInterface" style="display:none; margin-top:20px;">
                <div class="section-header" style="margin-bottom:15px;">
                    <div class="section-icon" style="background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);">💬</div>
                    <h2>Result-based Conversation</h2>
                </div>
                <div id="chatHistory" style="max-height:300px; overflow-y:auto; margin-bottom:15px;">
                    <!-- 聊天记录将在这里显示 -->
                </div>
                <div style="display:flex; gap:10px;">
                    <textarea id="userMessage" placeholder="Enter your question or instruction..." style="flex:1;"></textarea>
                    <button id="sendMessage" class="btn" style="align-self:flex-end;">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 说话人编辑弹窗 -->
<div id="speakerModal" class="speaker-modal">
    <div class="speaker-modal-content">
        <div class="modal-header">
            <h2>Edit Speakers</h2>
            <span class="close-modal" id="closeSpeakerModal">&times;</span>
        </div>
        <div id="speakersList">
            <!-- 说话人项将通过JavaScript动态添加 -->
        </div>
        <button id="saveSpeakersBtn" class="save-speakers-btn">Save Changes</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
    function generateUniqueId() {
        return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    const taskId = generateUniqueId();

    // 全局变量，用于跟踪当前时间格式
    let isUTC = false;

    // 时间格式切换功能
    document.getElementById('timeFormatToggle').addEventListener('change', function () {
        isUTC = this.checked;
        document.querySelector('.time-format-local').classList.toggle('time-format-active', !isUTC);
        document.querySelector('.time-format-utc').classList.toggle('time-format-active', isUTC);

        // 更新所有时间显示
        updateAllTimeDisplays();
    });

    // 更新所有时间显示格式
    function updateAllTimeDisplays() {

        // 更新日期选择器
        const startTimeInputs = document.querySelectorAll('input[name="start_time"]');
        const endTimeInputs = document.querySelectorAll('input[name="end_time"]');

        startTimeInputs.forEach(input => {
            if (input.value) {
                const dateObj = new Date(input.value + (isUTC ? "" : "Z"));
                input.value = isUTC ? toUTCISOString(dateObj) : toLocalISOString(dateObj);
            }
        });

        endTimeInputs.forEach(input => {
            if (input.value) {
                const dateObj = new Date(input.value + (isUTC ? "" : "Z"));
                input.value = isUTC ? toUTCISOString(dateObj) : toLocalISOString(dateObj);
            }
        });

        // 更新文件夹列表显示
        refreshFolderDisplayTimes();
    }

    // 刷新文件夹显示时间
    function refreshFolderDisplayTimes() {
        const folderItems = document.querySelectorAll('#folderDropdown .dropdown-item');
        folderItems.forEach(item => {
            if (item.dataset.utcStartTime && item.dataset.utcEndTime) {
                const startTime = new Date(item.dataset.utcStartTime + "Z"); // 确保使用UTC时间
                const endTime = new Date(item.dataset.utcEndTime + "Z");

                const displayStartTime = isUTC ?
                    item.dataset.utcStartTime.replace('T', ' ').replace('Z', '').replaceAll('-0', '/').replaceAll('-', '/').split(".")[0] :
                    startTime.toLocaleString();

                const displayEndTime = isUTC ?
                    item.dataset.utcEndTime.replace('T', ' ').replace('Z', '').replaceAll('-0', '/').replaceAll('-', '/').split(".")[0] :
                    endTime.toLocaleString();

                // 更新文本显示
                if (item.textContent !== 'All Folders' && item.textContent !== 'No recording folders found' && item.textContent !== 'Error loading folders') {
                    const folderName = item.textContent.split('(')[0].trim();
                    item.textContent = `${folderName} (${displayStartTime} - ${displayEndTime})`;
                }
            }
        });

        // 如果当前有选中的文件夹，更新选中文件夹的信息显示
        const searchInput = document.getElementById('folderSearchInput');
        if (searchInput.value && searchInput.value !== 'All Folders') {
            const selectedItem = Array.from(folderItems).find(item =>
                item.textContent.split('(')[0].trim() === searchInput.value.split('(')[0].trim());
            if (selectedItem) {
                selectFolder(selectedItem, false);
            }
        }
    }

    // 按钮禁用/启用函数
    function disableButton(btn, loadingText = null) {
        btn.disabled = true;
        btn.dataset.originalHtml = btn.innerHTML;
        if (loadingText) {
            btn.innerHTML = `<span class="loading-spinner"></span> ${loadingText}`;
        }
        btn.style.opacity = '0.7';
        btn.style.cursor = 'not-allowed';
    }

    function enableButton(btn) {
        btn.disabled = false;
        if (btn.dataset.originalHtml) {
            btn.innerHTML = btn.dataset.originalHtml;
        }
        btn.style.opacity = '';
        btn.style.cursor = '';
    }

    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-btn-header");
        for (i = 0; i < tablinks.length; i++) {
            if (tablinks[i].style.display === "none") {
            }
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
        document.getElementById(tabName).className += " active";

        // 在切换标签页时同步时间选择器
        if (tabName === "downloadTab") {
            // 从工作流标签页复制时间到下载标签页
            const workflowStartTime = document.querySelector('#workflowTab input[name="start_time"]').value;
            const workflowEndTime = document.querySelector('#workflowTab input[name="end_time"]').value;
            document.querySelector('#downloadTab input[name="start_time"]').value = workflowStartTime;
            document.querySelector('#downloadTab input[name="end_time"]').value = workflowEndTime;
        } else if (tabName === "workflowTab") {
            // 从下载标签页复制时间到工作流标签页
            const downloadStartTime = document.querySelector('#downloadTab input[name="start_time"]').value;
            const downloadEndTime = document.querySelector('#downloadTab input[name="end_time"]').value;
            document.querySelector('#workflowTab input[name="start_time"]').value = downloadStartTime;
            document.querySelector('#workflowTab input[name="end_time"]').value = downloadEndTime;
        }
    }

    // 设置处理类型切换按钮的事件处理程序
    document.addEventListener('DOMContentLoaded', function () {
        // 处理类型切换
        document.getElementById('processAudio').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('processAudio').classList.add('active');
            document.getElementById('processText').classList.remove('active');
            document.getElementById('audioProcessSection').style.display = '';
            document.getElementById('textProcessSection').style.display = 'none';
            document.getElementById('inputTypeField').value = 'audio';
        });

        document.getElementById('processText').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('processText').classList.add('active');
            document.getElementById('processAudio').classList.remove('active');
            document.getElementById('audioProcessSection').style.display = 'none';
            document.getElementById('textProcessSection').style.display = '';
            document.getElementById('inputTypeField').value = 'text';
        });

        // 加载工作流列表
        fetch('/get_workflows')
            .then(response => response.json())
            .then(data => {
                const workflows = data.workflows || [];
                const audioWorkflowSelect = document.getElementById('audioWorkflowSelect');
                const textWorkflowSelect = document.getElementById('textWorkflowSelect');

                // 清空现有选项
                audioWorkflowSelect.innerHTML = '<option value="">-- Select a workflow --</option>';
                textWorkflowSelect.innerHTML = '<option value="">-- Select a workflow --</option>';

                // 分类添加工作流选项
                workflows.forEach(workflow => {
                    const option = document.createElement('option');
                    option.value = workflow.name;
                    option.textContent = workflow.name;
                    option.dataset.description = workflow.description || '';
                    option.dataset.apiEndpoint = workflow.api_endpoint || '';
                    option.dataset.apiKey = workflow.api_key || '';
                    option.dataset.inputType = workflow.input_type || 'text';
                    option.dataset.customPrompt = workflow.custom_prompt || '';

                    // 根据工作流类型添加到不同的选择器
                    if (workflow.input_type === 'audio') {
                        audioWorkflowSelect.appendChild(option.cloneNode(true));
                    } else {
                        textWorkflowSelect.appendChild(option.cloneNode(true));
                    }
                });
            })
            .catch(error => {
                console.error('Error loading workflows:', error);
            });

        // 监听音频工作流选择变化
        document.getElementById('audioWorkflowSelect').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const description = selectedOption.dataset.description || '';
            const apiEndpoint = selectedOption.dataset.apiEndpoint || '';

            // 显示工作流描述
            document.getElementById('audioWorkflowDescription').textContent = description;

            // 处理自定义API输入框
            const audioApiUrlSection = document.getElementById('audioApiUrlSection');
            if (selectedOption.value.includes('Custom API')) {
                audioApiUrlSection.style.display = '';
                document.getElementById('audioApiUrl').value = apiEndpoint;
                document.getElementById('audioApiKey').value = ''; // 清空API Key
            } else {
                audioApiUrlSection.style.display = 'none';
            }
        });

        // 监听文本工作流选择变化
        document.getElementById('textWorkflowSelect').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const description = selectedOption.dataset.description || '';
            const apiEndpoint = selectedOption.dataset.apiEndpoint || '';
            const customPrompt = selectedOption.dataset.customPrompt || '';

            // 显示工作流描述
            document.getElementById('textWorkflowDescription').textContent = description;

            // 处理自定义API输入框和自定义提示词输入框
            const textApiUrlSection = document.getElementById('textApiUrlSection');
            const customPromptSection = document.getElementById('customPromptSection');

            if (selectedOption.value.includes('Custom API')) {
                textApiUrlSection.style.display = '';
                customPromptSection.style.display = 'none';
                document.getElementById('textApiUrl').value = apiEndpoint;
                document.getElementById('textApiKey').value = ''; // 清空API Key
            } else if (selectedOption.value.includes('Summary') || selectedOption.value.includes('Chat') || customPrompt) {
                textApiUrlSection.style.display = 'none';
                customPromptSection.style.display = '';
                document.getElementById('customPrompt').value = customPrompt || "You are a professional meeting assistant. Please summarize the following meeting transcript. Your summary should be clear, concise, and well-structured.";
            } else {
                textApiUrlSection.style.display = 'none';
                customPromptSection.style.display = 'none';
            }
        });

        // 开始转录按钮事件
        document.getElementById('btnStartTranscription').addEventListener('click', function () {
            disableButton(this, 'Transcription...');
            startTranscription(this);
        });

        // 音频处理按钮事件
        document.getElementById('btnStartAudioWorkflow').addEventListener('click', function () {
            disableButton(this, 'Processing...');
            startAudioWorkflow(this);
        });

        // 文本处理按钮事件
        document.getElementById('btnStartTextWorkflow').addEventListener('click', function () {
            disableButton(this, 'Processing...');
            startTextWorkflow(this);
        });
    });

    // 开始转录流程 - 使用新的/transcribe接口
    function startTranscription(btn) {
        resetWorkflowUI();

        const form = document.getElementById('workflowForm');
        const startTime = form.querySelector('input[name="start_time"]').value;
        const endTime = form.querySelector('input[name="end_time"]').value;
        const selectedLanguage = form.querySelector('#languageSelect').value;
        const folderPath = document.getElementById('workflowFolderPath').value;

        // 新增：获取说话人数输入框的值
        const speakersNumInput = document.getElementById('speakersNumInput');
        let speakersNum = speakersNumInput && speakersNumInput.value ? parseInt(speakersNumInput.value, 10) : 0;
        if (isNaN(speakersNum)) speakersNum = 0;

        if (!startTime || !endTime) {
            alert('Please select both start and end times.');
            enableButton(btn);
            return;
        }

        document.getElementById('workflowProgressBar').style.display = '';

        const formData = new FormData();
        formData.set('start_time', isUTC ? startTime : toUTCString(startTime));
        formData.set('end_time', isUTC ? endTime : toUTCString(endTime));
        formData.set('language', selectedLanguage);
        formData.set('task_id', taskId);

        // 添加文件夹路径
        if (folderPath) {
            formData.set('folder_path', folderPath);
        }
        // 新增：添加speakers_num参数
        formData.set('speakers_num', speakersNum);

        const socket = io();
        let steps = [];
        let currentStep = 0;

        socket.on('connect', function() {
            console.log('Socket connected');
            console.log('starting transcription request');
            fetch('/transcribe', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    console.log('returned data:', data);
                    if (!data || !data.task_id) {
                        if (data && data.message) {
                            alert("Failed to start transcription: " + data.message);
                        } else {
                            alert("Failed to start transcription: Unknown error");
                        }
                        enableButton(btn);
                        document.getElementById('workflowProgressBar').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Transcription failed: ' + error);
                    document.getElementById('workflowProgressBar').style.display = 'none';
                    enableButton(btn);
                });
        });

        socket.on('workflow_progress', function (msg) {
            if (!msg || msg.task_id !== taskId) return;

            steps.push(msg.message);
            currentStep++;
            updateProgressBar(steps, currentStep);

            if (msg.step === 'done') {
                // 转录完成，显示结果
                document.getElementById('transcribeTextarea').value = msg.result || '';
                console.log(msg.speaker_map)
                document.getElementById('transcribeResultSection').style.display = '';
                document.getElementById('transcribeStatusSection').style.display = 'none';
                document.getElementById('workflowProgressBar').style.display = 'none';
                socket.disconnect();
                enableButton(btn);
            }
        });
    }

    // 开始音频处理工作流 - 使用新的/process_workflow接口
    function startAudioWorkflow(btn) {
        resetWorkflowUI();

        const form = document.getElementById('workflowForm');
        const startTime = form.querySelector('input[name="start_time"]').value;
        const endTime = form.querySelector('input[name="end_time"]').value;
        const selectedWorkflow = document.getElementById('audioWorkflowSelect').value;
        const folderPath = document.getElementById('workflowFolderPath').value;

        if (!startTime || !endTime) {
            alert('Please select both start and end times.');
            enableButton(btn);
            return;
        }

        if (!selectedWorkflow) {
            alert('Please select a workflow.');
            enableButton(btn);
            return;
        }

        const formData = new FormData();
        formData.set('start_time', isUTC ? startTime : toUTCString(startTime));
        formData.set('end_time', isUTC ? endTime : toUTCString(endTime));
        formData.set('selected_workflow', selectedWorkflow);
        formData.set('input_type', 'audio');

        // 添加文件夹路径
        if (folderPath) {
            formData.set('folder_path', folderPath);
        }

        if (selectedWorkflow.includes('Custom API')) {
            const apiUrl = document.getElementById('audioApiUrl').value;
            const apiKey = document.getElementById('audioApiKey').value;

            if (!apiUrl) {
                alert('Please enter an API URL for the custom API workflow.');
                enableButton(btn);
                return;
            }
            formData.set('audio_api_url', apiUrl);
            if (apiKey) {
                formData.set('audio_api_key', apiKey);
            }
        }

        // 直接使用同步请求处理工作流
        fetch('/process_workflow', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('workflowResult').style.display = 'block';
                renderWorkflowResult(data.result || data);
                enableButton(btn);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('workflowResult').innerText = "Request failed: " + error;
                document.getElementById('workflowResult').style.display = 'block';
                enableButton(btn);
            });
    }

    // 开始文本处理工作流 - 使用新的/process_workflow接口
    function startTextWorkflow(btn) {
        resetWorkflowUI();

        const form = document.getElementById('workflowForm');
        const startTime = form.querySelector('input[name="start_time"]').value;
        const endTime = form.querySelector('input[name="end_time"]').value;
        const selectedWorkflow = document.getElementById('textWorkflowSelect').value;
        const transcript = document.getElementById('transcribeTextarea').value;
        const folderPath = document.getElementById('workflowFolderPath').value;

        if (!startTime || !endTime) {
            alert('Please select both start and end times.');
            enableButton(btn);
            return;
        }

        if (!selectedWorkflow) {
            alert('Please select a workflow.');
            enableButton(btn);
            return;
        }

        if (!transcript) {
            alert('Transcript is empty. Please run transcription first.');
            enableButton(btn);
            return;
        }

        const formData = new FormData();
        formData.set('start_time', isUTC ? startTime : toUTCString(startTime));
        formData.set('end_time', isUTC ? endTime : toUTCString(endTime));
        formData.set('selected_workflow', selectedWorkflow);
        formData.set('transcript', transcript);
        formData.set('input_type', 'text');

        // 添加文件夹路径
        if (folderPath) {
            formData.set('folder_path', folderPath);
        }

        if (selectedWorkflow.includes('Custom API')) {
            const apiUrl = document.getElementById('textApiUrl').value;
            const apiKey = document.getElementById('textApiKey').value;

            if (!apiUrl) {
                alert('Please enter an API URL for the custom API workflow.');
                enableButton(btn);
                return;
            }
            formData.set('text_api_url', apiUrl);
            if (apiKey) {
                formData.set('text_api_key', apiKey);
            }
        } else if (document.getElementById('customPromptSection').style.display !== 'none') {
            const customPrompt = document.getElementById('customPrompt').value;
            if (customPrompt) {
                formData.set('custom_prompt', customPrompt);
            }
        }

        // 直接使用同步请求处理工作流
        fetch('/process_workflow', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('workflowResult').style.display = 'block';
                renderWorkflowResult(data.result || data);
                enableButton(btn);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('workflowResult').innerText = "Request failed: " + error;
                document.getElementById('workflowResult').style.display = 'block';
                enableButton(btn);
            });
    }

    // 更新进度条
    function updateProgressBar(steps, currentStep) {
        let totalSteps = Math.max(5, currentStep + 2);
        let percent = Math.min(100, Math.round((currentStep / totalSteps) * 100));
        document.getElementById('workflowProgressInner').style.width = percent + '%';

        const ul = document.getElementById('workflowSteps');
        ul.innerHTML = '';
        steps.forEach((step) => {
            ul.innerHTML += `<li style="margin-bottom:4px;">${step}</li>`;
        });
    }

    // 重置工作流UI
    function resetWorkflowUI() {
        document.getElementById('workflowResult').style.display = 'none';
        document.getElementById('workflowResult').innerHTML = '';
        document.getElementById('workflowProgressBar').style.display = 'none';
        document.getElementById('workflowProgressInner').style.width = '0%';
        document.getElementById('workflowSteps').innerHTML = '';
    }

    // 渲染工作流结果
    function renderWorkflowResult(result) {
        const container = document.getElementById('workflowResult');
        container.innerHTML = '';
        if (!result) return;

        if (typeof result === 'string') {
            // 链接
            if (/^https?:\/\/.+/.test(result)) {
                if (/\.(mp3|wav|ogg)$/i.test(result)) {
                    container.innerHTML = `<audio controls src="${result}" style="width:100%"></audio>`;
                } else if (/\.(mp4|webm|mov)$/i.test(result)) {
                    container.innerHTML = `<video controls src="${result}" style="width:100%"></video>`;
                } else {
                    container.innerHTML = `<a href="${result}" target="_blank">${result}</a>`;
                }
            } else {
                container.innerText = result;
                // 显示聊天界面
                document.getElementById('chatInterface').style.display = 'block';
                // 保存处理结果用于后续对话
                container.dataset.content = result;
            }
        } else if (result && result.type && result.url) {
            // 后端返回结构化类型
            if (result.type === 'audio') {
                container.innerHTML = `<audio controls src="${result.url}" style="width:100%"></audio>`;
            } else if (result.type === 'video') {
                container.innerHTML = `<video controls src="${result.url}" style="width:100%"></video>`;
            } else if (result.type === 'link') {
                container.innerHTML = `<a href="${result.url}" target="_blank">${result.url}</a>`;
            } else {
                container.innerText = result.content || JSON.stringify(result);
                // 显示聊天界面
                document.getElementById('chatInterface').style.display = 'block';
                // 保存处理结果用于后续对话
                container.dataset.content = result.content || JSON.stringify(result);
            }
        } else {
            container.innerText = typeof result === 'object' ? JSON.stringify(result) : result;
            // 显示聊天界面
            document.getElementById('chatInterface').style.display = 'block';
            // 保存处理结果用于后续对话
            container.dataset.content = typeof result === 'object' ? JSON.stringify(result) : result;
        }
        document.getElementById('btnStartTextWorkflow').innerText = 'Regenerate';
        document.getElementById('btnStartTextWorkflow').dataset.originalHtml = document.getElementById('btnStartTextWorkflow').innerHTML;
    }

    // 格式化时间 - 总是返回UTC格式，用于API请求
    function toUTCString(localStr) {
        const date = new Date(localStr);
        return date.getUTCFullYear() + '-' +
            String(date.getUTCMonth() + 1).padStart(2, '0') + '-' +
            String(date.getUTCDate()).padStart(2, '0') + 'T' +
            String(date.getUTCHours()).padStart(2, '0') + ':' +
            String(date.getUTCMinutes()).padStart(2, '0') + ':' +
            String(date.getUTCSeconds()).padStart(2, '0');
    }

    // 转换为本地ISO字符串格式
    function toLocalISOString(date) {
        const pad = n => String(n).padStart(2, '0');
        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        const seconds = pad(date.getSeconds());

        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
    }

    // 转换为UTC ISO字符串格式
    function toUTCISOString(date) {
        const pad = n => String(n).padStart(2, '0');
        const year = date.getUTCFullYear();
        const month = pad(date.getUTCMonth() + 1);
        const day = pad(date.getUTCDate());
        const hours = pad(date.getUTCHours());
        const minutes = pad(date.getUTCMinutes());
        const seconds = pad(date.getUTCSeconds());

        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
    }

    // 新增：文件夹搜索与选择功能
    function setupFolderSearch() {
        const searchInput = document.getElementById('folderSearchInput');
        const folderDropdown = document.getElementById('folderDropdown');
        const selectedFolderInfo = document.getElementById('selectedFolderInfo');

        // 点击输入框显示下拉框
        searchInput.addEventListener('click', () => {
            folderDropdown.classList.add('show');
        });

        // 输入时过滤下拉框选项
        searchInput.addEventListener('input', () => {
            const filter = searchInput.value.toLowerCase();
            const items = folderDropdown.getElementsByClassName('dropdown-item');

            let hasVisibleItems = false;

            for (let i = 0; i < items.length; i++) {
                const text = items[i].textContent.toLowerCase();
                if (text.includes(filter)) {
                    items[i].style.display = '';
                    hasVisibleItems = true;
                } else {
                    items[i].style.display = 'none';
                }
            }

            if (!folderDropdown.classList.contains('show')) {
                folderDropdown.classList.add('show');
            }
        });

        // 点击其他地方时隐藏下拉框
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !folderDropdown.contains(e.target)) {
                folderDropdown.classList.remove('show');
            }
        });
    }

    // 修改：加载文件夹列表到下拉框
    function loadFolderList() {
        fetch('/get_folders')
            .then(response => response.json())
            .then(data => {
                const folderDropdown = document.getElementById('folderDropdown');
                // 保留"All Folders"选项，清除其他选项
                const allFoldersOption = folderDropdown.querySelector('.dropdown-item');
                folderDropdown.innerHTML = '';
                folderDropdown.appendChild(allFoldersOption);

                if (!data.folders || data.folders.length === 0) {
                    const noFolders = document.createElement('div');
                    noFolders.className = 'dropdown-item';
                    noFolders.textContent = 'No recording folders found';
                    folderDropdown.appendChild(noFolders);
                    return;
                }

                data.folders.forEach(folder => {
                    const folderItem = document.createElement('div');
                    folderItem.className = 'dropdown-item';

                    // 存储原始UTC时间
                    folderItem.dataset.utcStartTime = folder.start_time;
                    folderItem.dataset.utcEndTime = folder.end_time;

                    // 根据当前模式显示时间
                    const startDate = new Date(folder.start_time + "Z");
                    const endDate = new Date(folder.end_time + "Z");

                    const displayStartTime = isUTC ?
                        folder.start_time.replace('T', ' ') :
                        startDate.toLocaleString();

                    const displayEndTime = isUTC ?
                        folder.end_time.replace('T', ' ') :
                        endDate.toLocaleString();

                    folderItem.textContent = folder.folder_name + ' (' + displayStartTime + ' - ' + displayEndTime + ')';
                    folderItem.dataset.folderPath = folder.folder_path;
                    folderItem.dataset.fileCount = folder.file_count;
                    folderItem.dataset.durationMinutes = folder.duration_minutes;

                    // 添加点击事件
                    folderItem.addEventListener('click', () => {
                        selectFolder(folderItem);
                    });

                    folderDropdown.appendChild(folderItem);
                });

                // 默认选择"All Folders"
                selectFolder(allFoldersOption);
                allFoldersOption.addEventListener('click', () => {
                    selectFolder(allFoldersOption);
                })
            })
            .catch(error => {
                console.error('Error loading folders:', error);
                const folderDropdown = document.getElementById('folderDropdown');
                folderDropdown.innerHTML = '<div class="dropdown-item">Error loading folders</div>';
            });
    }

    // 选择文件夹
    function selectFolder(folderItem, updateTimeInputs = true) {
        const searchInput = document.getElementById('folderSearchInput');
        const folderDropdown = document.getElementById('folderDropdown');
        const selectedFolderInfo = document.getElementById('selectedFolderInfo');

        // 设置输入框的值
        searchInput.value = folderItem.textContent;

        // 隐藏下拉框
        folderDropdown.classList.remove('show');

        // 设置隐藏的文件夹路径输入
        document.getElementById('downloadFolderPath').value = folderItem.dataset.folderPath || '';
        document.getElementById('workflowFolderPath').value = folderItem.dataset.folderPath || '';

        // 显示所选文件夹信息
        if (folderItem.textContent === 'All Folders') {
            selectedFolderInfo.style.display = 'none';
            // 对于"All Folders"，不自动设置时间范围
        } else {
            // 显示文件夹信息
            selectedFolderInfo.innerHTML = `
                    <strong>${folderItem.dataset.folderPath}</strong>:
                    ${folderItem.dataset.fileCount} files,
                    ${folderItem.dataset.durationMinutes} minutes
                `;
            selectedFolderInfo.style.display = '';

            // 设置时间范围
            if (updateTimeInputs && folderItem.dataset.utcStartTime && folderItem.dataset.utcEndTime) {
                setTimeRangeFromFolder({
                    utc_start_time: folderItem.dataset.utcStartTime,
                    utc_end_time: folderItem.dataset.utcEndTime
                });
            }
        }
    }

    // 设置时间范围从选定的文件夹
    function setTimeRangeFromFolder(folder) {
        const startDate = new Date(folder.utc_start_time + "Z");
        const endDate = new Date(folder.utc_end_time + "Z");

        // 根据当前时间模式格式化
        const startTimeFormatted = isUTC ? toUTCISOString(startDate) : toLocalISOString(startDate);
        const endTimeFormatted = isUTC ? toUTCISOString(endDate) : toLocalISOString(endDate);

        // 设置所有时间输入框
        document.querySelectorAll('input[name="start_time"]').forEach(input => {
            input.value = startTimeFormatted;
        });

        document.querySelectorAll('input[name="end_time"]').forEach(input => {
            input.value = endTimeFormatted;
        });
    }

    // 格式化日期时间显示
    function formatDateTime(date) {
        const options = {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return date.toLocaleDateString(undefined, options);
    }

    // 设置默认时间范围
    window.onload = function () {
        // 初始化文件夹搜索功能
        setupFolderSearch();

        // 加载文件夹列表
        loadFolderList();

        const now = new Date();
        const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
        const oneHourLater = new Date(now.getTime());
        const startTimeInputs = document.querySelectorAll('input[name="start_time"]');
        const endTimeInputs = document.querySelectorAll('input[name="end_time"]');

        startTimeInputs.forEach(input => {
            input.value = toLocalISOString(oneHourAgo);
        });

        endTimeInputs.forEach(input => {
            input.value = toLocalISOString(oneHourLater);
        });
    }


// 保留与下载相关的表单处理
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('downloadForm').onsubmit = async function (e) {
        e.preventDefault();

        // 禁用下载按钮
        const downloadBtn = this.querySelector('button[type="submit"]');
        disableButton(downloadBtn, 'Downloading...');

        const form = this;
        const startInput = form.querySelector('input[name="start_time"]');
        const endInput = form.querySelector('input[name="end_time"]');
        const folderPath = document.getElementById('downloadFolderPath').value;

        const formData = new FormData();
        formData.append('start_time', isUTC ? startInput.value : toUTCString(startInput.value));
        formData.append('end_time', isUTC ? endInput.value : toUTCString(endInput.value));

        // 添加文件夹路径参数
        if (folderPath) {
            formData.append('folder_path', folderPath);
        }

        try {
            const resp = await fetch('/download', {
                method: 'POST',
                body: formData
            });

            if (resp.ok) {
                const blob = await resp.blob();
                // 尝试从header获取文件名
                let filename = 'audio.wav';
                const disposition = resp.headers.get('Content-Disposition');
                if (disposition && disposition.indexOf('filename=') !== -1) {
                    filename = decodeURIComponent(disposition.split('filename=')[1].replace(/['"]/g, ''));
                }
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } else {
                const data = await resp.json();
                alert('下载失败: ' + (data.message || '未知错误'));
            }
        } catch (err) {
            alert('请求出错: ' + err.message);
        } finally {
            enableButton(downloadBtn);
        }
    }
});

    // 聊天功能初始化
    function initChat() {
        const sendButton = document.getElementById('sendMessage');
        const userInput = document.getElementById('userMessage');
        const chatHistory = document.getElementById('chatHistory');

        // 聊天消息历史
        let messageHistory = [];

        // 发送按钮事件
        sendButton.addEventListener('click', function() {
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            // 禁用发送按钮和输入框
            sendButton.disabled = true;
            sendButton.innerText = 'Sending...';
            userInput.disabled = true;

            // 添加用户消息到界面
            addMessage('user', userMessage);

            // 记录用户消息
            messageHistory.push({
                role: 'user',
                content: userMessage
            });

            // 清空输入框
            userInput.value = '';

            // 显示正在输入指示器
            showTypingIndicator();

            // 获取工作流结果内容
            const workflowResult = document.getElementById('workflowResult').dataset.content || '';
            const transcriptContent = document.getElementById('transcribeTextarea') ?
                document.getElementById('transcribeTextarea').value : '';

            // 获取当前选择的工作流
            const workflowSelect = document.getElementById('textWorkflowSelect');
            const selectedWorkflow = workflowSelect && workflowSelect.value ? workflowSelect.value : '';

            // 发送聊天请求
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    history: messageHistory,
                    workflow_result: workflowResult,
                    transcript: transcriptContent,
                    selected_workflow: selectedWorkflow
                })
            })
            .then(response => response.json())
            .then(data => {
                // 移除正在输入指示器
                removeTypingIndicator();

                if (data && data.response) {
                    // 添加AI回复到界面
                    addMessage('ai', data.response);

                    // 记录AI回复
                    messageHistory.push({
                        role: 'assistant',
                        content: data.response
                    });
                } else {
                    // 处理错误情况
                    addMessage('ai', 'Sorry, I’m unable to process your request.');
                }
            })
            .catch(error => {
                console.error('聊天请求错误:', error);
                removeTypingIndicator();
                addMessage('ai', 'An error occurred. Please try again later.');
            })
            .finally(() => {
                // 恢复发送按钮和输入框
                sendButton.disabled = false;
                sendButton.innerText = 'Send';
                userInput.disabled = false;
            });
        });

        // Enter键发送消息
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendButton.click();
            }
        });

        // 添加消息到聊天历史
        function addMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}-message`;

            // 转换markdown格式（简单实现）
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');

            messageDiv.innerHTML = formattedContent;

            // 添加时间
            const timeSpan = document.createElement('div');
            timeSpan.className = 'message-time';
            timeSpan.textContent = new Date().toLocaleTimeString();
            messageDiv.appendChild(timeSpan);

            chatHistory.appendChild(messageDiv);

            // 滚动到底部
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // 显示正在输入指示器
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            chatHistory.appendChild(indicator);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // 移除正在输入指示器
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
    }

    // 初始化聊天功能
    document.addEventListener('DOMContentLoaded', function () {
        // ...existing code...

        // 初始化聊天功能
        initChat();
    });

    // 说话人编辑功能
    document.addEventListener('DOMContentLoaded', function() {
        // 说话人编辑按钮和弹窗元素
        const editSpeakersBtn = document.getElementById('editSpeakersBtn');
        const speakerModal = document.getElementById('speakerModal');
        const closeSpeakerModal = document.getElementById('closeSpeakerModal');
        const saveSpeakersBtn = document.getElementById('saveSpeakersBtn');
        const speakersList = document.getElementById('speakersList');

        // 存储说话人数据
        let speakersData = {};
        // 存储音频播放器
        let audioPlayers = {};

        // 解析转录文本中的说话人信息
        function parseSpeakersFromTranscript(transcript) {
            const lines = transcript.split('\n');
            const speakers = {};

            lines.forEach(line => {
                // 匹配格式: [00:00:00.000 --> 00:00:06.794] [SPEAKER_01] 发言内容
                const match = line.match(/\[(.*?)] \[(.*?)] (.*)/);
                if (match) {
                    const timeRange = match[1];
                    const speakerId = match[2];
                    const utterance = match[3];

                    if (!speakers[speakerId]) {
                        speakers[speakerId] = {
                            name: '', // 初始为空，等待用户命名
                            utterances: []
                        };
                    }

                    // 解析时间范围
                    const timeMatch = timeRange.match(/(\d+:\d+:\d+\.\d+) --> (\d+:\d+:\d+\.\d+)/);
                    if (timeMatch) {
                        const startTime = timeMatch[1];
                        const endTime = timeMatch[2];

                        speakers[speakerId].utterances.push({
                            startTime: startTime,
                            endTime: endTime,
                            text: utterance,
                            timeRange: timeRange
                        });
                    }
                }
            });

            return speakers;
        }

        // 打开说话人编辑弹窗
        function openSpeakerModal() {
            const transcript = document.getElementById('transcribeTextarea').value;
            speakersData = parseSpeakersFromTranscript(transcript);

            // 清空现有内容
            speakersList.innerHTML = '';

            // 为每个说话人创建一个编辑部分
            Object.keys(speakersData).forEach(speakerId => {
                const speaker = speakersData[speakerId];

                // 创建说话人项
                const speakerItem = document.createElement('div');
                speakerItem.className = 'speaker-item';
                speakerItem.dataset.speakerId = speakerId;

                // 说话人标题和名称输入
                const speakerHeader = document.createElement('div');
                speakerHeader.className = 'speaker-header';

                const speakerTitle = document.createElement('h3');
                speakerTitle.textContent = speakerId;

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'speaker-name-input';
                nameInput.placeholder = 'Enter speaker name';
                nameInput.value = speaker.name || '';
                nameInput.dataset.speakerId = speakerId;

                speakerHeader.appendChild(speakerTitle);
                speakerHeader.appendChild(nameInput);
                speakerItem.appendChild(speakerHeader);

                // 添加前三句话
                const utterances = speaker.utterances;
                const initialUtterances = utterances.slice(0, 3);
                const remainingUtterances = utterances.slice(3);

                // 初始话语容器
                const initialContainer = document.createElement('div');
                initialContainer.className = 'initial-utterances';
                speakerItem.appendChild(initialContainer);

                // 添加初始显示的话语
                initialUtterances.forEach(utterance => {
                    const utteranceItem = createUtteranceItem(utterance, speakerId);
                    initialContainer.appendChild(utteranceItem);
                });

                // 如果有更多话语，添加"显示更多"按钮和隐藏的容器
                if (remainingUtterances.length > 0) {
                    // 更多话语的容器
                    const moreContainer = document.createElement('div');
                    moreContainer.className = 'more-utterances';
                    moreContainer.style.display = 'none';
                    speakerItem.appendChild(moreContainer);

                    // 添加剩余话语
                    remainingUtterances.forEach(utterance => {
                        const utteranceItem = createUtteranceItem(utterance, speakerId);
                        moreContainer.appendChild(utteranceItem);
                    });

                    // 添加"显示更多"按钮
                    const showMoreBtn = document.createElement('button');
                    showMoreBtn.className = 'show-more-btn';
                    showMoreBtn.textContent = `Show more (${remainingUtterances.length})`;
                    showMoreBtn.dataset.expanded = 'false';
                    showMoreBtn.addEventListener('click', function() {
                        const expanded = this.dataset.expanded === 'true';
                        moreContainer.style.display = expanded ? 'none' : 'block';
                        this.textContent = expanded ?
                            `Show more (${remainingUtterances.length})` :
                            'Collapse';
                        this.dataset.expanded = expanded ? 'false' : 'true';
                    });
                    speakerItem.appendChild(showMoreBtn);
                }

                speakersList.appendChild(speakerItem);
            });

            speakerModal.style.display = 'block';
        }

        // 创建话语项
        function createUtteranceItem(utterance, speakerId) {
            const utteranceItem = document.createElement('div');
            utteranceItem.className = 'utterance-item';

            const timeElement = document.createElement('div');
            timeElement.className = 'utterance-time';
            timeElement.textContent = utterance.timeRange;

            const textElement = document.createElement('div');
            textElement.className = 'utterance-text';
            textElement.textContent = utterance.text;

            // 添加播放按钮
            const playButton = document.createElement('button');
            playButton.className = 'play-audio-btn';
            playButton.innerHTML = '▶';
            playButton.dataset.startTime = utterance.startTime;
            playButton.dataset.endTime = utterance.endTime;
            playButton.dataset.speakerId = speakerId;
            playButton.title = 'Play this segment';
            playButton.addEventListener('click', function() {
                playAudioSegment(this);
            });

            utteranceItem.appendChild(timeElement);
            utteranceItem.appendChild(textElement);
            utteranceItem.appendChild(playButton);

            return utteranceItem;
        }

        // 播放音频片段
        function playAudioSegment(button) {
            const startTime = button.dataset.startTime;
            const endTime = button.dataset.endTime;
            const speakerId = button.dataset.speakerId;

            // 获取当前表单数据以构建音频URL
            const form = document.getElementById('workflowForm');
            const startTimeInput = form.querySelector('input[name="start_time"]').value;
            const endTimeInput = form.querySelector('input[name="end_time"]').value;
            const folderPath = document.getElementById('workflowFolderPath').value;

            // 转换时间为秒数，用于定位音频
            const startSeconds = timeToSeconds(startTime);
            const endSeconds = timeToSeconds(endTime);

            // 构造唯一ID
            const playerId = `player-${speakerId}-${startSeconds}-${endSeconds}`;

            // 检查是否已有播放器
            const parentElement = button.parentElement;
            let audioPlayer = parentElement.querySelector('.audio-player');

            if (audioPlayer) {
                // 已有播放器，切换显示/隐藏
                if (audioPlayer.style.display === 'none') {
                    audioPlayer.style.display = 'block';

                    // 如果已经加载过，直接播放
                    if (audioPlayers[playerId]) {
                        audioPlayers[playerId].play();
                    }
                } else {
                    audioPlayer.style.display = 'none';

                    // 暂停播放
                    if (audioPlayers[playerId]) {
                        audioPlayers[playerId].pause();
                    }
                }
                return;
            }

            // 创建新的音频播放器
            audioPlayer = document.createElement('audio');
            audioPlayer.className = 'audio-player';
            audioPlayer.controls = true;
            audioPlayer.id = playerId;
            parentElement.appendChild(audioPlayer);

            // 构建获取音频片段的URL
            const formData = new FormData();
            formData.set('start_time', isUTC ? startTimeInput : toUTCString(startTimeInput));
            formData.set('end_time', isUTC ? endTimeInput : toUTCString(endTimeInput));
            if (folderPath) {
                formData.set('folder_path', folderPath);
            }
            formData.set('segment_start', startSeconds.toString());
            formData.set('segment_end', endSeconds.toString());

            // 显示加载状态
            button.innerHTML = '⏳';
            button.disabled = true;

            // 请求音频片段
            fetch('/download_segment', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                audioPlayer.src = url;
                audioPlayer.onended = () => {
                    // 播放结束后，恢复播放按钮
                    button.innerHTML = '▶';
                };
                audioPlayer.onplay = () => {
                    button.innerHTML = '⏸';
                };
                audioPlayer.onpause = () => {
                    button.innerHTML = '▶';
                };

                // 存储播放器引用
                audioPlayers[playerId] = audioPlayer;

                // 启用按钮
                button.disabled = false;

                // 自动播放
                audioPlayer.play();
            })
            .catch(error => {
                console.error('Error fetching audio segment:', error);
                button.innerHTML = '❌';
                button.disabled = false;

                // 移除播放器
                audioPlayer.remove();
            });
        }

        // 将时间字符串转换为秒数
        function timeToSeconds(timeStr) {
            const parts = timeStr.split(':');
            const seconds = parts.length > 2 ?
                parseFloat(parts[0]) * 3600 + parseFloat(parts[1]) * 60 + parseFloat(parts[2]) :
                parseFloat(parts[0]) * 60 + parseFloat(parts[1]);
            return seconds;
        }

        // 保存说话人名称并更新转录文本
        function saveSpeakerNames() {
            const nameInputs = document.querySelectorAll('.speaker-name-input');
            const transcript = document.getElementById('transcribeTextarea');
            let updatedText = transcript.value;

            // 收集所有说话人名称
            nameInputs.forEach(input => {
                const speakerId = input.dataset.speakerId;
                const speakerName = input.value.trim();

                if (speakerName) {
                    // 更新数据
                    speakersData[speakerId].name = speakerName;

                    // 更新转录文本
                    const regex = new RegExp(`\\[${speakerId}\\]`, 'g');
                    updatedText = updatedText.replace(regex, `[${speakerName}]`);
                }
            });

            // 更新转录文本
            transcript.value = updatedText;

            // 关闭弹窗
            speakerModal.style.display = 'none';
        }

        // 初始化事件监听
        if (editSpeakersBtn) {
            editSpeakersBtn.addEventListener('click', openSpeakerModal);
        }

        if (closeSpeakerModal) {
            closeSpeakerModal.addEventListener('click', function() {
                speakerModal.style.display = 'none';
            });
        }

        if (saveSpeakersBtn) {
            saveSpeakersBtn.addEventListener('click', saveSpeakerNames);
        }

        // 点击弹窗外部关闭弹窗
        window.addEventListener('click', function(event) {
            if (event.target === speakerModal) {
                speakerModal.style.display = 'none';
            }
        });

        // 修改转录完成处理，添加编辑说话人按钮的显示
        const originalSocketHandler = window.onload;
        window.onload = function() {
            if (typeof originalSocketHandler === 'function') {
                originalSocketHandler();
            }

            // 在转录完成时显示编辑说话人按钮
            const socket = io();
            socket.on('workflow_progress', function(msg) {
                if (msg && msg.step === 'done') {
                    // 转录完成后，确保编辑说话人按钮可见
                    if (document.getElementById('editSpeakersBtn')) {
                        document.getElementById('editSpeakersBtn').style.display = 'inline-block';
                    }
                }
            });
        };
    });
</script>
</body>
</html>
