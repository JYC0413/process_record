<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Selection & Download</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 40px;
            position: relative;
            z-index: 10;
        }

        .header-container {
            position: relative;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Êó∂Èó¥ÂàáÊç¢ÂºÄÂÖ≥Ê†∑Âºè */
        .time-toggle-container {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .time-format {
            font-weight: 600;
        }

        .time-format-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ËÆæÁΩÆÊåâÈíÆÊ†∑Âºè */
        .settings-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            color: #fff;
            transform: translateY(-50%) rotate(30deg);
        }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #1f1f3f 0%, #1a1a2e 100%);
            margin: 10% auto;
            padding: 30px;
            width: 80%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-header {
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #fff;
        }

        .success-message {
            background: rgba(39, 174, 96, 0.2);
            border-left: 4px solid #27ae60;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
        }

        .section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1000;
        }

        .section:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .section-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
        }

        .tab-container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 30px;
            display: flex;
            gap: 8px;
        }

        .tab-btn-header, .tab-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            position: relative;
        }

        .tab-btn-header:hover, .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
        }

        .tab-btn-header.active, .tab-btn.active {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            position: relative;
            z-index: 1;
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        input[type="datetime-local"] {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="datetime-local"]:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loader {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #workflowResult {
            display: none;
            margin-top: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
        }

        textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
            min-height: 120px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .section {
                padding: 20px;
            }

            .btn {
                padding: 10px 20px;
            }
        }

        /* ÊêúÁ¥¢Ê°Ü‰∏ãÊãâËèúÂçïÊ†∑Âºè */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding-right: 40px; /* ‰∏∫‰∏ãÊãâÁÆ≠Â§¥ÁïôÁ©∫Èó¥ */
        }

        .dropdown-arrow {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: #1f1f3f;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .dropdown-list.show {
            display: block;
        }

        /* Êñá‰ª∂Â§πÂàóË°®Ê†∑Âºè */
        .folder-list {
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
        }

        .folder-item {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .folder-item:last-child {
            border-bottom: none;
        }

        .folder-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .folder-item.selected {
            background: rgba(102, 126, 234, 0.2);
            border-left: 4px solid #667eea;
        }

        .folder-name {
            font-weight: 500;
        }

        .folder-info {
            font-size: 0.8rem;
            color: #b0b0b0;
        }

        .folder-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
        }

        /* ËÅäÂ§©ÁïåÈù¢Ê†∑Âºè */
        .chat-message {
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            max-width: 80%;
        }

        .user-message {
            background: rgba(102, 126, 234, 0.15);
            margin-left: auto;
            border-top-right-radius: 2px;
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.05);
            margin-right: auto;
            border-top-left-radius: 2px;
        }

        .message-time {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
            text-align: right;
        }

        #sendMessage {
            transition: all 0.3s;
        }

        #sendMessage:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            padding: 10px 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 10px;
            width: fit-content;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            background: #667eea;
            display: block;
            margin: 0 2px;
            opacity: 0.4;
        }

        .typing-indicator span:nth-child(1) {
            animation: bounce 1s infinite 0.1s;
        }

        .typing-indicator span:nth-child(2) {
            animation: bounce 1s infinite 0.3s;
        }

        .typing-indicator span:nth-child(3) {
            animation: bounce 1s infinite 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* ËØ¥ËØù‰∫∫ÁºñËæëÂºπÁ™óÊ†∑Âºè */
        .speaker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow: auto;
        }

        .speaker-modal-content {
            background: linear-gradient(135deg, #1f1f3f 0%, #1a1a2e 100%);
            margin: 5% auto;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .speaker-item {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .speaker-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .speaker-name-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            padding: 8px 12px;
            font-size: 1rem;
            width: 250px;
        }

        .utterance-item {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            position: relative;
        }

        .utterance-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .utterance-text {
            color: #fff;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .play-audio-btn {
            background: rgba(102, 126, 234, 0.2);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 10px;
            transition: all 0.2s;
        }

        .play-audio-btn:hover {
            background: rgba(102, 126, 234, 0.4);
        }

        .show-more-btn {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .show-more-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .save-speakers-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 10px 25px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto 0;
        }

        .save-speakers-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .edit-speakers-btn {
            background: rgba(102, 126, 234, 0.2);
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .edit-speakers-btn:hover {
            background: rgba(102, 126, 234, 0.4);
        }

        /* Èü≥È¢ëÊí≠ÊîæÂô®Ê†∑Âºè */
        .audio-player {
            width: 100%;
            height: 30px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header-container">
        <!-- Ê∑ªÂä†Êó∂Èó¥Ê†ºÂºèÂàáÊç¢ÂºÄÂÖ≥ -->
        <div class="time-toggle-container">
            <span class="time-format time-format-local time-format-active">LOCAL</span>
            <label class="toggle-switch">
                <input type="checkbox" id="timeFormatToggle">
                <span class="toggle-slider"></span>
            </label>
            <span class="time-format time-format-utc">UTC</span>
        </div>

        <h1>Meeting Audio Processing</h1>
        <div style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); display: flex; gap: 10px;">
            <button onclick="window.open('/config','_blank')" class="settings-btn" title="Settings">‚öôÔ∏è</button>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab-btn-header active" onclick="openTab(event, 'workflowTab')">
            <span class="tab-icon">üîÑ</span>
            Workflow
        </button>
        <button class="tab-btn-header" onclick="openTab(event, 'downloadTab')">
            <span class="tab-icon">üéß</span>
            Download Audio
        </button>
    </div>

    <!-- Êñ∞Â¢ûÔºöÊñá‰ª∂Â§πÈÄâÊã©ÈÉ®ÂàÜ -->
    <div class="section">
        <div class="section-header">
            <div class="section-icon">üìÅ</div>
            <h2>Select Recording Folder</h2>
        </div>
        <div class="form-group">
            <div class="search-container">
                <input type="text" id="folderSearchInput" class="search-input" placeholder="Search or select a folder"
                       style="width:100%;padding:12px 16px;padding-right:40px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                <span class="dropdown-arrow">‚ñº</span>
                <div id="folderDropdown" class="dropdown-list">
                    <div class="dropdown-item" data-folder-path="" data-start-time="" data-end-time="">All Folders</div>
                    <!-- Folders will be loaded here -->
                </div>
            </div>
        </div>
        <div id="selectedFolderInfo" style="margin-top: 10px; font-size: 0.9rem; color: #b0b0b0; display: none;">
            <!-- Selected folder info will be shown here -->
        </div>
    </div>

    <div id="downloadTab" class="tab-content">
        <div class="section">
            <div class="section-header">
                <div class="section-icon">üì•</div>
                <h2>Select Time Range for Audio Download</h2>
            </div>
            <form id="downloadForm" method="post" action="/download">
                <div class="form-group">
                    <label>Start Time:</label>
                    <input type="datetime-local" name="start_time" required step="1">
                </div>
                <div class="form-group">
                    <label>End Time:</label>
                    <input type="datetime-local" name="end_time" required step="1">
                </div>
                <!-- Ê∑ªÂä†ÈöêËóèÁöÑÊñá‰ª∂Â§πË∑ØÂæÑËæìÂÖ• -->
                <input type="hidden" name="folder_path" id="downloadFolderPath" value="">
                <div class="btn-container">
                    <button type="submit" class="btn">Download Merged Audio</button>
                    <div class="loader" id="downloadLoader"></div>
                </div>
            </form>
        </div>
    </div>

    <div id="workflowTab" class="tab-content active">
        <div class="section">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">üîÑ</div>
                <h2>Send Merged Audio to Workflow</h2>
            </div>
            <form id="workflowForm" method="post">
                <div class="form-group">
                    <label>Start Time:</label>
                    <input type="datetime-local" name="start_time" required step="1">
                </div>
                <div class="form-group">
                    <label>End Time:</label>
                    <input type="datetime-local" name="end_time" required step="1">
                </div>
                <!-- Ê∑ªÂä†ÈöêËóèÁöÑÊñá‰ª∂Â§πË∑ØÂæÑËæìÂÖ• -->
                <input type="hidden" name="folder_path" id="workflowFolderPath" value="">

                <!-- Â§ÑÁêÜÁ±ªÂûãÈÄâÊã© -->
                <div class="form-group">
                    <label>Processing Type:</label>
                    <div class="tab-container" style="margin-bottom:15px;">
                        <button type="button" class="tab-btn active" id="processText">
                            <span class="tab-icon">üìù</span>
                            Transcribe and process text
                        </button>
                        <button type="button" class="tab-btn" id="processAudio">
                            <span class="tab-icon">üîä</span>
                            Process audio
                        </button>
                    </div>
                </div>

                <!-- Èü≥È¢ëÂ§ÑÁêÜÊµÅÁ®ã (ÈªòËÆ§ÊòæÁ§∫) -->
                <div id="audioProcessSection" style="display:none;">
                    <div class="form-group">
                        <label for="audioWorkflowSelect">Select Audio Workflow:</label>
                        <select id="audioWorkflowSelect" name="selected_workflow"
                                style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                            <option value="">-- Select a workflow --</option>
                        </select>
                        <div id="audioWorkflowDescription" style="margin-top:8px;font-size:0.9rem;color:#b0b0b0;"></div>
                    </div>

                    <!-- Ëá™ÂÆö‰πâAPI URL (Èü≥È¢ë) -->
                    <div id="audioApiUrlSection" style="display:none;">
                        <div class="form-group">
                            <label for="audioApiUrl">API URL:</label>
                            <input type="text" id="audioApiUrl" name="audio_api_url"
                                   placeholder="http://your-api/handle"
                                   style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                        </div>
                        <!-- Ê∑ªÂä†API KeyËæìÂÖ•Â≠óÊÆµ -->
                        <div class="form-group">
                            <label for="audioApiKey">API Key (optional):</label>
                            <input type="text" id="audioApiKey" name="audio_api_key" placeholder="Your API Key"
                                   style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                        </div>
                    </div>

                    <div class="btn-container">
                        <button type="button" class="btn" id="btnStartAudioWorkflow">Start Audio Processing</button>
                        <div class="loader" id="audioProcessLoader" style="display:none;"></div>
                    </div>
                </div>

                <!-- ÊñáÊú¨Â§ÑÁêÜÊµÅÁ®ã (ÈªòËÆ§ÈöêËóè) -->
                <div id="textProcessSection">
                    <div class="form-group" id="transcribeStatusSection">
                        <!-- Ê∑ªÂä†ËØ≠Ë®ÄÈÄâÊã©‰∏ãÊãâËèúÂçï -->
                        <div class="form-group">
                            <label for="languageSelect">Recognition Language:</label>
                            <select id="languageSelect" name="language"
                                    style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                                <option value="auto">Auto-detect (Default)</option>
                                <option value="zh">Chinese (‰∏≠Êñá)</option>
                                <option value="en">English</option>
                                <option value="es">Spanish (Espa√±ol)</option>
                                <option value="fr">French (Fran√ßais)</option>
                                <option value="de">German (Deutsch)</option>
                                <option value="ja">Japanese (Êó•Êú¨Ë™û)</option>
                                <option value="ko">Korean (ÌïúÍµ≠Ïñ¥)</option>
                                <option value="ru">Russian (–†—É—Å—Å–∫–∏–π)</option>
                                <option value="pt">Portuguese (Portugu√™s)</option>
                                <option value="ar">Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
                                <option value="hi">Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                                <option value="it">Italian (Italiano)</option>
                            </select>
                        </div>
                        <!-- Êñ∞Â¢ûËØ¥ËØù‰∫∫Êï∞ËæìÂÖ•Ê°Ü -->
                        <div class="form-group">
                            <label for="speakersNumInput">Number of Speakers (optional):</label>
                            <input type="number" id="speakersNumInput" name="speakers_num" min="0" placeholder="Leave blank if unknown"
                                   style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                        </div>
                        <div class="btn-container">
                            <button type="button" class="btn" id="btnStartTranscription">Start Transcription</button>
                        </div>
                    </div>

                    <!-- ËΩ¨ÂΩïÁªìÊûúÈÉ®ÂàÜ (ÂºÄÂßãÈöêËóè) -->
                    <div id="transcribeResultSection" style="display:none;">
                        <div class="form-group">
                            <label for="transcribeTextarea">Recognition Result (editable):</label>
                            <textarea id="transcribeTextarea" name="transcript" style="min-height:120px;"></textarea>
                            <button type="button" id="editSpeakersBtn" class="edit-speakers-btn">
                                <span>üë§</span> Edit Speakers
                            </button>
                        </div>

                        <div class="form-group">
                            <label for="textWorkflowSelect">Select Text Workflow:</label>
                            <select id="textWorkflowSelect" name="selected_workflow"
                                    style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                                <option value="">-- Select a workflow --</option>
                            </select>
                            <div id="textWorkflowDescription"
                                 style="margin-top:8px;font-size:0.9rem;color:#b0b0b0;"></div>
                        </div>

                        <!-- Ëá™ÂÆö‰πâAPI URL (ÊñáÊú¨) -->
                        <div id="textApiUrlSection" style="display:none;">
                            <div class="form-group">
                                <label for="textApiUrl">API URL:</label>
                                <input type="text" id="textApiUrl" name="text_api_url"
                                       placeholder="http://your-api/handle"
                                       style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                            </div>
                            <!-- Ê∑ªÂä†API KeyËæìÂÖ•Â≠óÊÆµ -->
                            <div class="form-group">
                                <label for="textApiKey">API Key (optional):</label>
                                <input type="text" id="textApiKey" name="text_api_key" placeholder="Your API Key"
                                       style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                            </div>
                        </div>

                        <!-- Ëá™ÂÆö‰πâÊèêÁ§∫ËØçÈÉ®ÂàÜ -->
                        <div id="customPromptSection" style="display:none;">
                            <div class="form-group">
                                <label for="customPrompt">Custom Prompt:</label>
                                <textarea name="custom_prompt" id="customPrompt"
                                          placeholder="Enter a custom prompt for the AI..."></textarea>
                            </div>
                        </div>

                        <div class="btn-container">
                            <button type="button" class="btn" id="btnStartTextWorkflow">Process Text</button>
                            <div class="loader" id="textProcessLoader" style="display:none;"></div>
                        </div>
                    </div>
                </div>

                <input type="hidden" name="input_type" id="inputTypeField" value="audio">
            </form>

            <!-- ËøõÂ∫¶Êù°ÂíåÁªìÊûúÊòæÁ§∫ÈÉ®ÂàÜ -->
            <div id="workflowProgressBar" style="display:none;margin-top:20px;">
                <div style="background:#222;border-radius:8px;overflow:hidden;">
                    <div id="workflowProgressInner"
                         style="height:18px;width:0%;background:linear-gradient(90deg,#667eea,#764ba2);transition:width 0.3s;"></div>
                </div>
                <ul id="workflowSteps" style="margin-top:10px;font-size:14px;list-style:none;padding-left:0;"></ul>
            </div>
            <div id="workflowResult"></div>

            <!-- Ê∑ªÂä†ËÅäÂ§©ÁïåÈù¢ -->
            <div id="chatInterface" style="display:none; margin-top:20px;">
                <div class="section-header" style="margin-bottom:15px;">
                    <div class="section-icon" style="background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);">üí¨</div>
                    <h2>Result-based Conversation</h2>
                </div>
                <div id="chatHistory" style="max-height:300px; overflow-y:auto; margin-bottom:15px;">
                    <!-- ËÅäÂ§©ËÆ∞ÂΩïÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
                <div style="display:flex; gap:10px;">
                    <textarea id="userMessage" placeholder="Enter your question or instruction..." style="flex:1;"></textarea>
                    <button id="sendMessage" class="btn" style="align-self:flex-end;">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ËØ¥ËØù‰∫∫ÁºñËæëÂºπÁ™ó -->
<div id="speakerModal" class="speaker-modal">
    <div class="speaker-modal-content">
        <div class="modal-header">
            <h2>Edit Speakers</h2>
            <span class="close-modal" id="closeSpeakerModal">&times;</span>
        </div>
        <div id="speakersList">
            <!-- ËØ¥ËØù‰∫∫È°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
        </div>
        <button id="saveSpeakersBtn" class="save-speakers-btn">Save Changes</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
    function generateUniqueId() {
        return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    const taskId = generateUniqueId();

    // ÂÖ®Â±ÄÂèòÈáèÔºåÁî®‰∫éË∑üË∏™ÂΩìÂâçÊó∂Èó¥Ê†ºÂºè
    let isUTC = false;

    // Êó∂Èó¥Ê†ºÂºèÂàáÊç¢ÂäüËÉΩ
    document.getElementById('timeFormatToggle').addEventListener('change', function () {
        isUTC = this.checked;
        document.querySelector('.time-format-local').classList.toggle('time-format-active', !isUTC);
        document.querySelector('.time-format-utc').classList.toggle('time-format-active', isUTC);

        // Êõ¥Êñ∞ÊâÄÊúâÊó∂Èó¥ÊòæÁ§∫
        updateAllTimeDisplays();
    });

    // Êõ¥Êñ∞ÊâÄÊúâÊó∂Èó¥ÊòæÁ§∫Ê†ºÂºè
    function updateAllTimeDisplays() {

        // Êõ¥Êñ∞Êó•ÊúüÈÄâÊã©Âô®
        const startTimeInputs = document.querySelectorAll('input[name="start_time"]');
        const endTimeInputs = document.querySelectorAll('input[name="end_time"]');

        startTimeInputs.forEach(input => {
            if (input.value) {
                const dateObj = new Date(input.value + (isUTC ? "" : "Z"));
                input.value = isUTC ? toUTCISOString(dateObj) : toLocalISOString(dateObj);
            }
        });

        endTimeInputs.forEach(input => {
            if (input.value) {
                const dateObj = new Date(input.value + (isUTC ? "" : "Z"));
                input.value = isUTC ? toUTCISOString(dateObj) : toLocalISOString(dateObj);
            }
        });

        // Êõ¥Êñ∞Êñá‰ª∂Â§πÂàóË°®ÊòæÁ§∫
        refreshFolderDisplayTimes();
    }

    // Âà∑Êñ∞Êñá‰ª∂Â§πÊòæÁ§∫Êó∂Èó¥
    function refreshFolderDisplayTimes() {
        const folderItems = document.querySelectorAll('#folderDropdown .dropdown-item');
        folderItems.forEach(item => {
            if (item.dataset.utcStartTime && item.dataset.utcEndTime) {
                const startTime = new Date(item.dataset.utcStartTime + "Z"); // Á°Æ‰øù‰ΩøÁî®UTCÊó∂Èó¥
                const endTime = new Date(item.dataset.utcEndTime + "Z");

                const displayStartTime = isUTC ?
                    item.dataset.utcStartTime.replace('T', ' ').replace('Z', '').replaceAll('-0', '/').replaceAll('-', '/').split(".")[0] :
                    startTime.toLocaleString();

                const displayEndTime = isUTC ?
                    item.dataset.utcEndTime.replace('T', ' ').replace('Z', '').replaceAll('-0', '/').replaceAll('-', '/').split(".")[0] :
                    endTime.toLocaleString();

                // Êõ¥Êñ∞ÊñáÊú¨ÊòæÁ§∫
                if (item.textContent !== 'All Folders' && item.textContent !== 'No recording folders found' && item.textContent !== 'Error loading folders') {
                    const folderName = item.textContent.split('(')[0].trim();
                    item.textContent = `${folderName} (${displayStartTime} - ${displayEndTime})`;
                }
            }
        });

        // Â¶ÇÊûúÂΩìÂâçÊúâÈÄâ‰∏≠ÁöÑÊñá‰ª∂Â§πÔºåÊõ¥Êñ∞ÈÄâ‰∏≠Êñá‰ª∂Â§πÁöÑ‰ø°ÊÅØÊòæÁ§∫
        const searchInput = document.getElementById('folderSearchInput');
        if (searchInput.value && searchInput.value !== 'All Folders') {
            const selectedItem = Array.from(folderItems).find(item =>
                item.textContent.split('(')[0].trim() === searchInput.value.split('(')[0].trim());
            if (selectedItem) {
                selectFolder(selectedItem, false);
            }
        }
    }

    // ÊåâÈíÆÁ¶ÅÁî®/ÂêØÁî®ÂáΩÊï∞
    function disableButton(btn, loadingText = null) {
        btn.disabled = true;
        btn.dataset.originalHtml = btn.innerHTML;
        if (loadingText) {
            btn.innerHTML = `<span class="loading-spinner"></span> ${loadingText}`;
        }
        btn.style.opacity = '0.7';
        btn.style.cursor = 'not-allowed';
    }

    function enableButton(btn) {
        btn.disabled = false;
        if (btn.dataset.originalHtml) {
            btn.innerHTML = btn.dataset.originalHtml;
        }
        btn.style.opacity = '';
        btn.style.cursor = '';
    }

    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-btn-header");
        for (i = 0; i < tablinks.length; i++) {
            if (tablinks[i].style.display === "none") {
            }
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
        document.getElementById(tabName).className += " active";

        // Âú®ÂàáÊç¢Ê†áÁ≠æÈ°µÊó∂ÂêåÊ≠•Êó∂Èó¥ÈÄâÊã©Âô®
        if (tabName === "downloadTab") {
            // ‰ªéÂ∑•‰ΩúÊµÅÊ†áÁ≠æÈ°µÂ§çÂà∂Êó∂Èó¥Âà∞‰∏ãËΩΩÊ†áÁ≠æÈ°µ
            const workflowStartTime = document.querySelector('#workflowTab input[name="start_time"]').value;
            const workflowEndTime = document.querySelector('#workflowTab input[name="end_time"]').value;
            document.querySelector('#downloadTab input[name="start_time"]').value = workflowStartTime;
            document.querySelector('#downloadTab input[name="end_time"]').value = workflowEndTime;
        } else if (tabName === "workflowTab") {
            // ‰ªé‰∏ãËΩΩÊ†áÁ≠æÈ°µÂ§çÂà∂Êó∂Èó¥Âà∞Â∑•‰ΩúÊµÅÊ†áÁ≠æÈ°µ
            const downloadStartTime = document.querySelector('#downloadTab input[name="start_time"]').value;
            const downloadEndTime = document.querySelector('#downloadTab input[name="end_time"]').value;
            document.querySelector('#workflowTab input[name="start_time"]').value = downloadStartTime;
            document.querySelector('#workflowTab input[name="end_time"]').value = downloadEndTime;
        }
    }

    // ËÆæÁΩÆÂ§ÑÁêÜÁ±ªÂûãÂàáÊç¢ÊåâÈíÆÁöÑ‰∫ã‰ª∂Â§ÑÁêÜÁ®ãÂ∫è
    document.addEventListener('DOMContentLoaded', function () {
        // Â§ÑÁêÜÁ±ªÂûãÂàáÊç¢
        document.getElementById('processAudio').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('processAudio').classList.add('active');
            document.getElementById('processText').classList.remove('active');
            document.getElementById('audioProcessSection').style.display = '';
            document.getElementById('textProcessSection').style.display = 'none';
            document.getElementById('inputTypeField').value = 'audio';
        });

        document.getElementById('processText').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('processText').classList.add('active');
            document.getElementById('processAudio').classList.remove('active');
            document.getElementById('audioProcessSection').style.display = 'none';
            document.getElementById('textProcessSection').style.display = '';
            document.getElementById('inputTypeField').value = 'text';
        });

        // Âä†ËΩΩÂ∑•‰ΩúÊµÅÂàóË°®
        fetch('/get_workflows')
            .then(response => response.json())
            .then(data => {
                const workflows = data.workflows || [];
                const audioWorkflowSelect = document.getElementById('audioWorkflowSelect');
                const textWorkflowSelect = document.getElementById('textWorkflowSelect');

                // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
                audioWorkflowSelect.innerHTML = '<option value="">-- Select a workflow --</option>';
                textWorkflowSelect.innerHTML = '<option value="">-- Select a workflow --</option>';

                // ÂàÜÁ±ªÊ∑ªÂä†Â∑•‰ΩúÊµÅÈÄâÈ°π
                workflows.forEach(workflow => {
                    const option = document.createElement('option');
                    option.value = workflow.name;
                    option.textContent = workflow.name;
                    option.dataset.description = workflow.description || '';
                    option.dataset.apiEndpoint = workflow.api_endpoint || '';
                    option.dataset.apiKey = workflow.api_key || '';
                    option.dataset.inputType = workflow.input_type || 'text';
                    option.dataset.customPrompt = workflow.custom_prompt || '';

                    // Ê†πÊçÆÂ∑•‰ΩúÊµÅÁ±ªÂûãÊ∑ªÂä†Âà∞‰∏çÂêåÁöÑÈÄâÊã©Âô®
                    if (workflow.input_type === 'audio') {
                        audioWorkflowSelect.appendChild(option.cloneNode(true));
                    } else {
                        textWorkflowSelect.appendChild(option.cloneNode(true));
                    }
                });
            })
            .catch(error => {
                console.error('Error loading workflows:', error);
            });

        // ÁõëÂê¨Èü≥È¢ëÂ∑•‰ΩúÊµÅÈÄâÊã©ÂèòÂåñ
        document.getElementById('audioWorkflowSelect').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const description = selectedOption.dataset.description || '';
            const apiEndpoint = selectedOption.dataset.apiEndpoint || '';

            // ÊòæÁ§∫Â∑•‰ΩúÊµÅÊèèËø∞
            document.getElementById('audioWorkflowDescription').textContent = description;

            // Â§ÑÁêÜËá™ÂÆö‰πâAPIËæìÂÖ•Ê°Ü
            const audioApiUrlSection = document.getElementById('audioApiUrlSection');
            if (selectedOption.value.includes('Custom API')) {
                audioApiUrlSection.style.display = '';
                document.getElementById('audioApiUrl').value = apiEndpoint;
                document.getElementById('audioApiKey').value = ''; // Ê∏ÖÁ©∫API Key
            } else {
                audioApiUrlSection.style.display = 'none';
            }
        });

        // ÁõëÂê¨ÊñáÊú¨Â∑•‰ΩúÊµÅÈÄâÊã©ÂèòÂåñ
        document.getElementById('textWorkflowSelect').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const description = selectedOption.dataset.description || '';
            const apiEndpoint = selectedOption.dataset.apiEndpoint || '';
            const customPrompt = selectedOption.dataset.customPrompt || '';

            // ÊòæÁ§∫Â∑•‰ΩúÊµÅÊèèËø∞
            document.getElementById('textWorkflowDescription').textContent = description;

            // Â§ÑÁêÜËá™ÂÆö‰πâAPIËæìÂÖ•Ê°ÜÂíåËá™ÂÆö‰πâÊèêÁ§∫ËØçËæìÂÖ•Ê°Ü
            const textApiUrlSection = document.getElementById('textApiUrlSection');
            const customPromptSection = document.getElementById('customPromptSection');

            if (selectedOption.value.includes('Custom API')) {
                textApiUrlSection.style.display = '';
                customPromptSection.style.display = 'none';
                document.getElementById('textApiUrl').value = apiEndpoint;
                document.getElementById('textApiKey').value = ''; // Ê∏ÖÁ©∫API Key
            } else if (selectedOption.value.includes('Summary') || selectedOption.value.includes('Chat') || customPrompt) {
                textApiUrlSection.style.display = 'none';
                customPromptSection.style.display = '';
                document.getElementById('customPrompt').value = customPrompt || "You are a professional meeting assistant. Please summarize the following meeting transcript. Your summary should be clear, concise, and well-structured.";
            } else {
                textApiUrlSection.style.display = 'none';
                customPromptSection.style.display = 'none';
            }
        });

        // ÂºÄÂßãËΩ¨ÂΩïÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('btnStartTranscription').addEventListener('click', function () {
            disableButton(this, 'Transcription...');
            startTranscription(this);
        });

        // Èü≥È¢ëÂ§ÑÁêÜÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('btnStartAudioWorkflow').addEventListener('click', function () {
            disableButton(this, 'Processing...');
            startAudioWorkflow(this);
        });

        // ÊñáÊú¨Â§ÑÁêÜÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('btnStartTextWorkflow').addEventListener('click', function () {
            disableButton(this, 'Processing...');
            startTextWorkflow(this);
        });
    });

    // ÂºÄÂßãËΩ¨ÂΩïÊµÅÁ®ã - ‰ΩøÁî®Êñ∞ÁöÑ/transcribeÊé•Âè£
    function startTranscription(btn) {
        resetWorkflowUI();

        const form = document.getElementById('workflowForm');
        const startTime = form.querySelector('input[name="start_time"]').value;
        const endTime = form.querySelector('input[name="end_time"]').value;
        const selectedLanguage = form.querySelector('#languageSelect').value;
        const folderPath = document.getElementById('workflowFolderPath').value;

        // Êñ∞Â¢ûÔºöËé∑ÂèñËØ¥ËØù‰∫∫Êï∞ËæìÂÖ•Ê°ÜÁöÑÂÄº
        const speakersNumInput = document.getElementById('speakersNumInput');
        let speakersNum = speakersNumInput && speakersNumInput.value ? parseInt(speakersNumInput.value, 10) : 0;
        if (isNaN(speakersNum)) speakersNum = 0;

        if (!startTime || !endTime) {
            alert('Please select both start and end times.');
            enableButton(btn);
            return;
        }

        document.getElementById('workflowProgressBar').style.display = '';

        const formData = new FormData();
        formData.set('start_time', isUTC ? startTime : toUTCString(startTime));
        formData.set('end_time', isUTC ? endTime : toUTCString(endTime));
        formData.set('language', selectedLanguage);
        formData.set('task_id', taskId);

        // Ê∑ªÂä†Êñá‰ª∂Â§πË∑ØÂæÑ
        if (folderPath) {
            formData.set('folder_path', folderPath);
        }
        // Êñ∞Â¢ûÔºöÊ∑ªÂä†speakers_numÂèÇÊï∞
        formData.set('speakers_num', speakersNum);

        const socket = io();
        let steps = [];
        let currentStep = 0;

        socket.on('connect', function() {
            console.log('Socket connected');
            console.log('starting transcription request');
            fetch('/transcribe', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    console.log('returned data:', data);
                    if (!data || !data.task_id) {
                        if (data && data.message) {
                            alert("Failed to start transcription: " + data.message);
                        } else {
                            alert("Failed to start transcription: Unknown error");
                        }
                        enableButton(btn);
                        document.getElementById('workflowProgressBar').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Transcription failed: ' + error);
                    document.getElementById('workflowProgressBar').style.display = 'none';
                    enableButton(btn);
                });
        });

        socket.on('workflow_progress', function (msg) {
            if (!msg || msg.task_id !== taskId) return;

            steps.push(msg.message);
            currentStep++;
            updateProgressBar(steps, currentStep);

            if (msg.step === 'done') {
                // ËΩ¨ÂΩïÂÆåÊàêÔºåÊòæÁ§∫ÁªìÊûú
                document.getElementById('transcribeTextarea').value = msg.result || '';
                console.log(msg.speaker_map)
                document.getElementById('transcribeResultSection').style.display = '';
                document.getElementById('transcribeStatusSection').style.display = 'none';
                document.getElementById('workflowProgressBar').style.display = 'none';
                socket.disconnect();
                enableButton(btn);
            }
        });
    }

    // ÂºÄÂßãÈü≥È¢ëÂ§ÑÁêÜÂ∑•‰ΩúÊµÅ - ‰ΩøÁî®Êñ∞ÁöÑ/process_workflowÊé•Âè£
    function startAudioWorkflow(btn) {
        resetWorkflowUI();

        const form = document.getElementById('workflowForm');
        const startTime = form.querySelector('input[name="start_time"]').value;
        const endTime = form.querySelector('input[name="end_time"]').value;
        const selectedWorkflow = document.getElementById('audioWorkflowSelect').value;
        const folderPath = document.getElementById('workflowFolderPath').value;

        if (!startTime || !endTime) {
            alert('Please select both start and end times.');
            enableButton(btn);
            return;
        }

        if (!selectedWorkflow) {
            alert('Please select a workflow.');
            enableButton(btn);
            return;
        }

        const formData = new FormData();
        formData.set('start_time', isUTC ? startTime : toUTCString(startTime));
        formData.set('end_time', isUTC ? endTime : toUTCString(endTime));
        formData.set('selected_workflow', selectedWorkflow);
        formData.set('input_type', 'audio');

        // Ê∑ªÂä†Êñá‰ª∂Â§πË∑ØÂæÑ
        if (folderPath) {
            formData.set('folder_path', folderPath);
        }

        if (selectedWorkflow.includes('Custom API')) {
            const apiUrl = document.getElementById('audioApiUrl').value;
            const apiKey = document.getElementById('audioApiKey').value;

            if (!apiUrl) {
                alert('Please enter an API URL for the custom API workflow.');
                enableButton(btn);
                return;
            }
            formData.set('audio_api_url', apiUrl);
            if (apiKey) {
                formData.set('audio_api_key', apiKey);
            }
        }

        // Áõ¥Êé•‰ΩøÁî®ÂêåÊ≠•ËØ∑Ê±ÇÂ§ÑÁêÜÂ∑•‰ΩúÊµÅ
        fetch('/process_workflow', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('workflowResult').style.display = 'block';
                renderWorkflowResult(data.result || data);
                enableButton(btn);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('workflowResult').innerText = "Request failed: " + error;
                document.getElementById('workflowResult').style.display = 'block';
                enableButton(btn);
            });
    }

    // ÂºÄÂßãÊñáÊú¨Â§ÑÁêÜÂ∑•‰ΩúÊµÅ - ‰ΩøÁî®Êñ∞ÁöÑ/process_workflowÊé•Âè£
    function startTextWorkflow(btn) {
        resetWorkflowUI();

        const form = document.getElementById('workflowForm');
        const startTime = form.querySelector('input[name="start_time"]').value;
        const endTime = form.querySelector('input[name="end_time"]').value;
        const selectedWorkflow = document.getElementById('textWorkflowSelect').value;
        const transcript = document.getElementById('transcribeTextarea').value;
        const folderPath = document.getElementById('workflowFolderPath').value;

        if (!startTime || !endTime) {
            alert('Please select both start and end times.');
            enableButton(btn);
            return;
        }

        if (!selectedWorkflow) {
            alert('Please select a workflow.');
            enableButton(btn);
            return;
        }

        if (!transcript) {
            alert('Transcript is empty. Please run transcription first.');
            enableButton(btn);
            return;
        }

        const formData = new FormData();
        formData.set('start_time', isUTC ? startTime : toUTCString(startTime));
        formData.set('end_time', isUTC ? endTime : toUTCString(endTime));
        formData.set('selected_workflow', selectedWorkflow);
        formData.set('transcript', transcript);
        formData.set('input_type', 'text');

        // Ê∑ªÂä†Êñá‰ª∂Â§πË∑ØÂæÑ
        if (folderPath) {
            formData.set('folder_path', folderPath);
        }

        if (selectedWorkflow.includes('Custom API')) {
            const apiUrl = document.getElementById('textApiUrl').value;
            const apiKey = document.getElementById('textApiKey').value;

            if (!apiUrl) {
                alert('Please enter an API URL for the custom API workflow.');
                enableButton(btn);
                return;
            }
            formData.set('text_api_url', apiUrl);
            if (apiKey) {
                formData.set('text_api_key', apiKey);
            }
        } else if (document.getElementById('customPromptSection').style.display !== 'none') {
            const customPrompt = document.getElementById('customPrompt').value;
            if (customPrompt) {
                formData.set('custom_prompt', customPrompt);
            }
        }

        // Áõ¥Êé•‰ΩøÁî®ÂêåÊ≠•ËØ∑Ê±ÇÂ§ÑÁêÜÂ∑•‰ΩúÊµÅ
        fetch('/process_workflow', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('workflowResult').style.display = 'block';
                renderWorkflowResult(data.result || data);
                enableButton(btn);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('workflowResult').innerText = "Request failed: " + error;
                document.getElementById('workflowResult').style.display = 'block';
                enableButton(btn);
            });
    }

    // Êõ¥Êñ∞ËøõÂ∫¶Êù°
    function updateProgressBar(steps, currentStep) {
        let totalSteps = Math.max(5, currentStep + 2);
        let percent = Math.min(100, Math.round((currentStep / totalSteps) * 100));
        document.getElementById('workflowProgressInner').style.width = percent + '%';

        const ul = document.getElementById('workflowSteps');
        ul.innerHTML = '';
        steps.forEach((step) => {
            ul.innerHTML += `<li style="margin-bottom:4px;">${step}</li>`;
        });
    }

    // ÈáçÁΩÆÂ∑•‰ΩúÊµÅUI
    function resetWorkflowUI() {
        document.getElementById('workflowResult').style.display = 'none';
        document.getElementById('workflowResult').innerHTML = '';
        document.getElementById('workflowProgressBar').style.display = 'none';
        document.getElementById('workflowProgressInner').style.width = '0%';
        document.getElementById('workflowSteps').innerHTML = '';
    }

    // Ê∏≤ÊüìÂ∑•‰ΩúÊµÅÁªìÊûú
    function renderWorkflowResult(result) {
        const container = document.getElementById('workflowResult');
        container.innerHTML = '';
        if (!result) return;

        if (typeof result === 'string') {
            // ÈìæÊé•
            if (/^https?:\/\/.+/.test(result)) {
                if (/\.(mp3|wav|ogg)$/i.test(result)) {
                    container.innerHTML = `<audio controls src="${result}" style="width:100%"></audio>`;
                } else if (/\.(mp4|webm|mov)$/i.test(result)) {
                    container.innerHTML = `<video controls src="${result}" style="width:100%"></video>`;
                } else {
                    container.innerHTML = `<a href="${result}" target="_blank">${result}</a>`;
                }
            } else {
                container.innerText = result;
                // ÊòæÁ§∫ËÅäÂ§©ÁïåÈù¢
                document.getElementById('chatInterface').style.display = 'block';
                // ‰øùÂ≠òÂ§ÑÁêÜÁªìÊûúÁî®‰∫éÂêéÁª≠ÂØπËØù
                container.dataset.content = result;
            }
        } else if (result && result.type && result.url) {
            // ÂêéÁ´ØËøîÂõûÁªìÊûÑÂåñÁ±ªÂûã
            if (result.type === 'audio') {
                container.innerHTML = `<audio controls src="${result.url}" style="width:100%"></audio>`;
            } else if (result.type === 'video') {
                container.innerHTML = `<video controls src="${result.url}" style="width:100%"></video>`;
            } else if (result.type === 'link') {
                container.innerHTML = `<a href="${result.url}" target="_blank">${result.url}</a>`;
            } else {
                container.innerText = result.content || JSON.stringify(result);
                // ÊòæÁ§∫ËÅäÂ§©ÁïåÈù¢
                document.getElementById('chatInterface').style.display = 'block';
                // ‰øùÂ≠òÂ§ÑÁêÜÁªìÊûúÁî®‰∫éÂêéÁª≠ÂØπËØù
                container.dataset.content = result.content || JSON.stringify(result);
            }
        } else {
            container.innerText = typeof result === 'object' ? JSON.stringify(result) : result;
            // ÊòæÁ§∫ËÅäÂ§©ÁïåÈù¢
            document.getElementById('chatInterface').style.display = 'block';
            // ‰øùÂ≠òÂ§ÑÁêÜÁªìÊûúÁî®‰∫éÂêéÁª≠ÂØπËØù
            container.dataset.content = typeof result === 'object' ? JSON.stringify(result) : result;
        }
        document.getElementById('btnStartTextWorkflow').innerText = 'Regenerate';
        document.getElementById('btnStartTextWorkflow').dataset.originalHtml = document.getElementById('btnStartTextWorkflow').innerHTML;
    }

    // Ê†ºÂºèÂåñÊó∂Èó¥ - ÊÄªÊòØËøîÂõûUTCÊ†ºÂºèÔºåÁî®‰∫éAPIËØ∑Ê±Ç
    function toUTCString(localStr) {
        const date = new Date(localStr);
        return date.getUTCFullYear() + '-' +
            String(date.getUTCMonth() + 1).padStart(2, '0') + '-' +
            String(date.getUTCDate()).padStart(2, '0') + 'T' +
            String(date.getUTCHours()).padStart(2, '0') + ':' +
            String(date.getUTCMinutes()).padStart(2, '0') + ':' +
            String(date.getUTCSeconds()).padStart(2, '0');
    }

    // ËΩ¨Êç¢‰∏∫Êú¨Âú∞ISOÂ≠óÁ¨¶‰∏≤Ê†ºÂºè
    function toLocalISOString(date) {
        const pad = n => String(n).padStart(2, '0');
        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        const seconds = pad(date.getSeconds());

        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
    }

    // ËΩ¨Êç¢‰∏∫UTC ISOÂ≠óÁ¨¶‰∏≤Ê†ºÂºè
    function toUTCISOString(date) {
        const pad = n => String(n).padStart(2, '0');
        const year = date.getUTCFullYear();
        const month = pad(date.getUTCMonth() + 1);
        const day = pad(date.getUTCDate());
        const hours = pad(date.getUTCHours());
        const minutes = pad(date.getUTCMinutes());
        const seconds = pad(date.getUTCSeconds());

        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
    }

    // Êñ∞Â¢ûÔºöÊñá‰ª∂Â§πÊêúÁ¥¢‰∏éÈÄâÊã©ÂäüËÉΩ
    function setupFolderSearch() {
        const searchInput = document.getElementById('folderSearchInput');
        const folderDropdown = document.getElementById('folderDropdown');
        const selectedFolderInfo = document.getElementById('selectedFolderInfo');

        // ÁÇπÂáªËæìÂÖ•Ê°ÜÊòæÁ§∫‰∏ãÊãâÊ°Ü
        searchInput.addEventListener('click', () => {
            folderDropdown.classList.add('show');
        });

        // ËæìÂÖ•Êó∂ËøáÊª§‰∏ãÊãâÊ°ÜÈÄâÈ°π
        searchInput.addEventListener('input', () => {
            const filter = searchInput.value.toLowerCase();
            const items = folderDropdown.getElementsByClassName('dropdown-item');

            let hasVisibleItems = false;

            for (let i = 0; i < items.length; i++) {
                const text = items[i].textContent.toLowerCase();
                if (text.includes(filter)) {
                    items[i].style.display = '';
                    hasVisibleItems = true;
                } else {
                    items[i].style.display = 'none';
                }
            }

            if (!folderDropdown.classList.contains('show')) {
                folderDropdown.classList.add('show');
            }
        });

        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÊó∂ÈöêËóè‰∏ãÊãâÊ°Ü
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !folderDropdown.contains(e.target)) {
                folderDropdown.classList.remove('show');
            }
        });
    }

    // ‰øÆÊîπÔºöÂä†ËΩΩÊñá‰ª∂Â§πÂàóË°®Âà∞‰∏ãÊãâÊ°Ü
    function loadFolderList() {
        fetch('/get_folders')
            .then(response => response.json())
            .then(data => {
                const folderDropdown = document.getElementById('folderDropdown');
                // ‰øùÁïô"All Folders"ÈÄâÈ°πÔºåÊ∏ÖÈô§ÂÖ∂‰ªñÈÄâÈ°π
                const allFoldersOption = folderDropdown.querySelector('.dropdown-item');
                folderDropdown.innerHTML = '';
                folderDropdown.appendChild(allFoldersOption);

                if (!data.folders || data.folders.length === 0) {
                    const noFolders = document.createElement('div');
                    noFolders.className = 'dropdown-item';
                    noFolders.textContent = 'No recording folders found';
                    folderDropdown.appendChild(noFolders);
                    return;
                }

                data.folders.forEach(folder => {
                    const folderItem = document.createElement('div');
                    folderItem.className = 'dropdown-item';

                    // Â≠òÂÇ®ÂéüÂßãUTCÊó∂Èó¥
                    folderItem.dataset.utcStartTime = folder.start_time;
                    folderItem.dataset.utcEndTime = folder.end_time;

                    // Ê†πÊçÆÂΩìÂâçÊ®°ÂºèÊòæÁ§∫Êó∂Èó¥
                    const startDate = new Date(folder.start_time + "Z");
                    const endDate = new Date(folder.end_time + "Z");

                    const displayStartTime = isUTC ?
                        folder.start_time.replace('T', ' ') :
                        startDate.toLocaleString();

                    const displayEndTime = isUTC ?
                        folder.end_time.replace('T', ' ') :
                        endDate.toLocaleString();

                    folderItem.textContent = folder.folder_name + ' (' + displayStartTime + ' - ' + displayEndTime + ')';
                    folderItem.dataset.folderPath = folder.folder_path;
                    folderItem.dataset.fileCount = folder.file_count;
                    folderItem.dataset.durationMinutes = folder.duration_minutes;

                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    folderItem.addEventListener('click', () => {
                        selectFolder(folderItem);
                    });

                    folderDropdown.appendChild(folderItem);
                });

                // ÈªòËÆ§ÈÄâÊã©"All Folders"
                selectFolder(allFoldersOption);
                allFoldersOption.addEventListener('click', () => {
                    selectFolder(allFoldersOption);
                })
            })
            .catch(error => {
                console.error('Error loading folders:', error);
                const folderDropdown = document.getElementById('folderDropdown');
                folderDropdown.innerHTML = '<div class="dropdown-item">Error loading folders</div>';
            });
    }

    // ÈÄâÊã©Êñá‰ª∂Â§π
    function selectFolder(folderItem, updateTimeInputs = true) {
        const searchInput = document.getElementById('folderSearchInput');
        const folderDropdown = document.getElementById('folderDropdown');
        const selectedFolderInfo = document.getElementById('selectedFolderInfo');

        // ËÆæÁΩÆËæìÂÖ•Ê°ÜÁöÑÂÄº
        searchInput.value = folderItem.textContent;

        // ÈöêËóè‰∏ãÊãâÊ°Ü
        folderDropdown.classList.remove('show');

        // ËÆæÁΩÆÈöêËóèÁöÑÊñá‰ª∂Â§πË∑ØÂæÑËæìÂÖ•
        document.getElementById('downloadFolderPath').value = folderItem.dataset.folderPath || '';
        document.getElementById('workflowFolderPath').value = folderItem.dataset.folderPath || '';

        // ÊòæÁ§∫ÊâÄÈÄâÊñá‰ª∂Â§π‰ø°ÊÅØ
        if (folderItem.textContent === 'All Folders') {
            selectedFolderInfo.style.display = 'none';
            // ÂØπ‰∫é"All Folders"Ôºå‰∏çËá™Âä®ËÆæÁΩÆÊó∂Èó¥ËåÉÂõ¥
        } else {
            // ÊòæÁ§∫Êñá‰ª∂Â§π‰ø°ÊÅØ
            selectedFolderInfo.innerHTML = `
                    <strong>${folderItem.dataset.folderPath}</strong>:
                    ${folderItem.dataset.fileCount} files,
                    ${folderItem.dataset.durationMinutes} minutes
                `;
            selectedFolderInfo.style.display = '';

            // ËÆæÁΩÆÊó∂Èó¥ËåÉÂõ¥
            if (updateTimeInputs && folderItem.dataset.utcStartTime && folderItem.dataset.utcEndTime) {
                setTimeRangeFromFolder({
                    utc_start_time: folderItem.dataset.utcStartTime,
                    utc_end_time: folderItem.dataset.utcEndTime
                });
            }
        }
    }

    // ËÆæÁΩÆÊó∂Èó¥ËåÉÂõ¥‰ªéÈÄâÂÆöÁöÑÊñá‰ª∂Â§π
    function setTimeRangeFromFolder(folder) {
        const startDate = new Date(folder.utc_start_time + "Z");
        const endDate = new Date(folder.utc_end_time + "Z");

        // Ê†πÊçÆÂΩìÂâçÊó∂Èó¥Ê®°ÂºèÊ†ºÂºèÂåñ
        const startTimeFormatted = isUTC ? toUTCISOString(startDate) : toLocalISOString(startDate);
        const endTimeFormatted = isUTC ? toUTCISOString(endDate) : toLocalISOString(endDate);

        // ËÆæÁΩÆÊâÄÊúâÊó∂Èó¥ËæìÂÖ•Ê°Ü
        document.querySelectorAll('input[name="start_time"]').forEach(input => {
            input.value = startTimeFormatted;
        });

        document.querySelectorAll('input[name="end_time"]').forEach(input => {
            input.value = endTimeFormatted;
        });
    }

    // Ê†ºÂºèÂåñÊó•ÊúüÊó∂Èó¥ÊòæÁ§∫
    function formatDateTime(date) {
        const options = {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return date.toLocaleDateString(undefined, options);
    }

    // ËÆæÁΩÆÈªòËÆ§Êó∂Èó¥ËåÉÂõ¥
    window.onload = function () {
        // ÂàùÂßãÂåñÊñá‰ª∂Â§πÊêúÁ¥¢ÂäüËÉΩ
        setupFolderSearch();

        // Âä†ËΩΩÊñá‰ª∂Â§πÂàóË°®
        loadFolderList();

        const now = new Date();
        const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
        const oneHourLater = new Date(now.getTime());
        const startTimeInputs = document.querySelectorAll('input[name="start_time"]');
        const endTimeInputs = document.querySelectorAll('input[name="end_time"]');

        startTimeInputs.forEach(input => {
            input.value = toLocalISOString(oneHourAgo);
        });

        endTimeInputs.forEach(input => {
            input.value = toLocalISOString(oneHourLater);
        });
    }


// ‰øùÁïô‰∏é‰∏ãËΩΩÁõ∏ÂÖ≥ÁöÑË°®ÂçïÂ§ÑÁêÜ
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('downloadForm').onsubmit = async function (e) {
        e.preventDefault();

        // Á¶ÅÁî®‰∏ãËΩΩÊåâÈíÆ
        const downloadBtn = this.querySelector('button[type="submit"]');
        disableButton(downloadBtn, 'Downloading...');

        const form = this;
        const startInput = form.querySelector('input[name="start_time"]');
        const endInput = form.querySelector('input[name="end_time"]');
        const folderPath = document.getElementById('downloadFolderPath').value;

        const formData = new FormData();
        formData.append('start_time', isUTC ? startInput.value : toUTCString(startInput.value));
        formData.append('end_time', isUTC ? endInput.value : toUTCString(endInput.value));

        // Ê∑ªÂä†Êñá‰ª∂Â§πË∑ØÂæÑÂèÇÊï∞
        if (folderPath) {
            formData.append('folder_path', folderPath);
        }

        try {
            const resp = await fetch('/download', {
                method: 'POST',
                body: formData
            });

            if (resp.ok) {
                const blob = await resp.blob();
                // Â∞ùËØï‰ªéheaderËé∑ÂèñÊñá‰ª∂Âêç
                let filename = 'audio.wav';
                const disposition = resp.headers.get('Content-Disposition');
                if (disposition && disposition.indexOf('filename=') !== -1) {
                    filename = decodeURIComponent(disposition.split('filename=')[1].replace(/['"]/g, ''));
                }
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } else {
                const data = await resp.json();
                alert('‰∏ãËΩΩÂ§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ'));
            }
        } catch (err) {
            alert('ËØ∑Ê±ÇÂá∫Èîô: ' + err.message);
        } finally {
            enableButton(downloadBtn);
        }
    }
});

    // ËÅäÂ§©ÂäüËÉΩÂàùÂßãÂåñ
    function initChat() {
        const sendButton = document.getElementById('sendMessage');
        const userInput = document.getElementById('userMessage');
        const chatHistory = document.getElementById('chatHistory');

        // ËÅäÂ§©Ê∂àÊÅØÂéÜÂè≤
        let messageHistory = [];

        // ÂèëÈÄÅÊåâÈíÆ‰∫ã‰ª∂
        sendButton.addEventListener('click', function() {
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            // Á¶ÅÁî®ÂèëÈÄÅÊåâÈíÆÂíåËæìÂÖ•Ê°Ü
            sendButton.disabled = true;
            sendButton.innerText = 'Sending...';
            userInput.disabled = true;

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÁïåÈù¢
            addMessage('user', userMessage);

            // ËÆ∞ÂΩïÁî®Êà∑Ê∂àÊÅØ
            messageHistory.push({
                role: 'user',
                content: userMessage
            });

            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            userInput.value = '';

            // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊåáÁ§∫Âô®
            showTypingIndicator();

            // Ëé∑ÂèñÂ∑•‰ΩúÊµÅÁªìÊûúÂÜÖÂÆπ
            const workflowResult = document.getElementById('workflowResult').dataset.content || '';
            const transcriptContent = document.getElementById('transcribeTextarea') ?
                document.getElementById('transcribeTextarea').value : '';

            // Ëé∑ÂèñÂΩìÂâçÈÄâÊã©ÁöÑÂ∑•‰ΩúÊµÅ
            const workflowSelect = document.getElementById('textWorkflowSelect');
            const selectedWorkflow = workflowSelect && workflowSelect.value ? workflowSelect.value : '';

            // ÂèëÈÄÅËÅäÂ§©ËØ∑Ê±Ç
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    history: messageHistory,
                    workflow_result: workflowResult,
                    transcript: transcriptContent,
                    selected_workflow: selectedWorkflow
                })
            })
            .then(response => response.json())
            .then(data => {
                // ÁßªÈô§Ê≠£Âú®ËæìÂÖ•ÊåáÁ§∫Âô®
                removeTypingIndicator();

                if (data && data.response) {
                    // Ê∑ªÂä†AIÂõûÂ§çÂà∞ÁïåÈù¢
                    addMessage('ai', data.response);

                    // ËÆ∞ÂΩïAIÂõûÂ§ç
                    messageHistory.push({
                        role: 'assistant',
                        content: data.response
                    });
                } else {
                    // Â§ÑÁêÜÈîôËØØÊÉÖÂÜµ
                    addMessage('ai', 'Sorry, I‚Äôm unable to process your request.');
                }
            })
            .catch(error => {
                console.error('ËÅäÂ§©ËØ∑Ê±ÇÈîôËØØ:', error);
                removeTypingIndicator();
                addMessage('ai', 'An error occurred. Please try again later.');
            })
            .finally(() => {
                // ÊÅ¢Â§çÂèëÈÄÅÊåâÈíÆÂíåËæìÂÖ•Ê°Ü
                sendButton.disabled = false;
                sendButton.innerText = 'Send';
                userInput.disabled = false;
            });
        });

        // EnterÈîÆÂèëÈÄÅÊ∂àÊÅØ
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendButton.click();
            }
        });

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©ÂéÜÂè≤
        function addMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}-message`;

            // ËΩ¨Êç¢markdownÊ†ºÂºèÔºàÁÆÄÂçïÂÆûÁé∞Ôºâ
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');

            messageDiv.innerHTML = formattedContent;

            // Ê∑ªÂä†Êó∂Èó¥
            const timeSpan = document.createElement('div');
            timeSpan.className = 'message-time';
            timeSpan.textContent = new Date().toLocaleTimeString();
            messageDiv.appendChild(timeSpan);

            chatHistory.appendChild(messageDiv);

            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊåáÁ§∫Âô®
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            chatHistory.appendChild(indicator);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // ÁßªÈô§Ê≠£Âú®ËæìÂÖ•ÊåáÁ§∫Âô®
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
    }

    // ÂàùÂßãÂåñËÅäÂ§©ÂäüËÉΩ
    document.addEventListener('DOMContentLoaded', function () {
        // ...existing code...

        // ÂàùÂßãÂåñËÅäÂ§©ÂäüËÉΩ
        initChat();
    });

    // ËØ¥ËØù‰∫∫ÁºñËæëÂäüËÉΩ
    document.addEventListener('DOMContentLoaded', function() {
        // ËØ¥ËØù‰∫∫ÁºñËæëÊåâÈíÆÂíåÂºπÁ™óÂÖÉÁ¥†
        const editSpeakersBtn = document.getElementById('editSpeakersBtn');
        const speakerModal = document.getElementById('speakerModal');
        const closeSpeakerModal = document.getElementById('closeSpeakerModal');
        const saveSpeakersBtn = document.getElementById('saveSpeakersBtn');
        const speakersList = document.getElementById('speakersList');

        // Â≠òÂÇ®ËØ¥ËØù‰∫∫Êï∞ÊçÆ
        let speakersData = {};
        // Â≠òÂÇ®Èü≥È¢ëÊí≠ÊîæÂô®
        let audioPlayers = {};

        // Ëß£ÊûêËΩ¨ÂΩïÊñáÊú¨‰∏≠ÁöÑËØ¥ËØù‰∫∫‰ø°ÊÅØ
        function parseSpeakersFromTranscript(transcript) {
            const lines = transcript.split('\n');
            const speakers = {};

            lines.forEach(line => {
                // ÂåπÈÖçÊ†ºÂºè: [00:00:00.000 --> 00:00:06.794] [SPEAKER_01] ÂèëË®ÄÂÜÖÂÆπ
                const match = line.match(/\[(.*?)] \[(.*?)] (.*)/);
                if (match) {
                    const timeRange = match[1];
                    const speakerId = match[2];
                    const utterance = match[3];

                    if (!speakers[speakerId]) {
                        speakers[speakerId] = {
                            name: '', // ÂàùÂßã‰∏∫Á©∫ÔºåÁ≠âÂæÖÁî®Êà∑ÂëΩÂêç
                            utterances: []
                        };
                    }

                    // Ëß£ÊûêÊó∂Èó¥ËåÉÂõ¥
                    const timeMatch = timeRange.match(/(\d+:\d+:\d+\.\d+) --> (\d+:\d+:\d+\.\d+)/);
                    if (timeMatch) {
                        const startTime = timeMatch[1];
                        const endTime = timeMatch[2];

                        speakers[speakerId].utterances.push({
                            startTime: startTime,
                            endTime: endTime,
                            text: utterance,
                            timeRange: timeRange
                        });
                    }
                }
            });

            return speakers;
        }

        // ÊâìÂºÄËØ¥ËØù‰∫∫ÁºñËæëÂºπÁ™ó
        function openSpeakerModal() {
            const transcript = document.getElementById('transcribeTextarea').value;
            speakersData = parseSpeakersFromTranscript(transcript);

            // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ
            speakersList.innerHTML = '';

            // ‰∏∫ÊØè‰∏™ËØ¥ËØù‰∫∫ÂàõÂª∫‰∏Ä‰∏™ÁºñËæëÈÉ®ÂàÜ
            Object.keys(speakersData).forEach(speakerId => {
                const speaker = speakersData[speakerId];

                // ÂàõÂª∫ËØ¥ËØù‰∫∫È°π
                const speakerItem = document.createElement('div');
                speakerItem.className = 'speaker-item';
                speakerItem.dataset.speakerId = speakerId;

                // ËØ¥ËØù‰∫∫Ê†áÈ¢òÂíåÂêçÁß∞ËæìÂÖ•
                const speakerHeader = document.createElement('div');
                speakerHeader.className = 'speaker-header';

                const speakerTitle = document.createElement('h3');
                speakerTitle.textContent = speakerId;

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'speaker-name-input';
                nameInput.placeholder = 'Enter speaker name';
                nameInput.value = speaker.name || '';
                nameInput.dataset.speakerId = speakerId;

                speakerHeader.appendChild(speakerTitle);
                speakerHeader.appendChild(nameInput);
                speakerItem.appendChild(speakerHeader);

                // Ê∑ªÂä†Ââç‰∏âÂè•ËØù
                const utterances = speaker.utterances;
                const initialUtterances = utterances.slice(0, 3);
                const remainingUtterances = utterances.slice(3);

                // ÂàùÂßãËØùËØ≠ÂÆπÂô®
                const initialContainer = document.createElement('div');
                initialContainer.className = 'initial-utterances';
                speakerItem.appendChild(initialContainer);

                // Ê∑ªÂä†ÂàùÂßãÊòæÁ§∫ÁöÑËØùËØ≠
                initialUtterances.forEach(utterance => {
                    const utteranceItem = createUtteranceItem(utterance, speakerId);
                    initialContainer.appendChild(utteranceItem);
                });

                // Â¶ÇÊûúÊúâÊõ¥Â§öËØùËØ≠ÔºåÊ∑ªÂä†"ÊòæÁ§∫Êõ¥Â§ö"ÊåâÈíÆÂíåÈöêËóèÁöÑÂÆπÂô®
                if (remainingUtterances.length > 0) {
                    // Êõ¥Â§öËØùËØ≠ÁöÑÂÆπÂô®
                    const moreContainer = document.createElement('div');
                    moreContainer.className = 'more-utterances';
                    moreContainer.style.display = 'none';
                    speakerItem.appendChild(moreContainer);

                    // Ê∑ªÂä†Ââ©‰ΩôËØùËØ≠
                    remainingUtterances.forEach(utterance => {
                        const utteranceItem = createUtteranceItem(utterance, speakerId);
                        moreContainer.appendChild(utteranceItem);
                    });

                    // Ê∑ªÂä†"ÊòæÁ§∫Êõ¥Â§ö"ÊåâÈíÆ
                    const showMoreBtn = document.createElement('button');
                    showMoreBtn.className = 'show-more-btn';
                    showMoreBtn.textContent = `Show more (${remainingUtterances.length})`;
                    showMoreBtn.dataset.expanded = 'false';
                    showMoreBtn.addEventListener('click', function() {
                        const expanded = this.dataset.expanded === 'true';
                        moreContainer.style.display = expanded ? 'none' : 'block';
                        this.textContent = expanded ?
                            `Show more (${remainingUtterances.length})` :
                            'Collapse';
                        this.dataset.expanded = expanded ? 'false' : 'true';
                    });
                    speakerItem.appendChild(showMoreBtn);
                }

                speakersList.appendChild(speakerItem);
            });

            speakerModal.style.display = 'block';
        }

        // ÂàõÂª∫ËØùËØ≠È°π
        function createUtteranceItem(utterance, speakerId) {
            const utteranceItem = document.createElement('div');
            utteranceItem.className = 'utterance-item';

            const timeElement = document.createElement('div');
            timeElement.className = 'utterance-time';
            timeElement.textContent = utterance.timeRange;

            const textElement = document.createElement('div');
            textElement.className = 'utterance-text';
            textElement.textContent = utterance.text;

            // Ê∑ªÂä†Êí≠ÊîæÊåâÈíÆ
            const playButton = document.createElement('button');
            playButton.className = 'play-audio-btn';
            playButton.innerHTML = '‚ñ∂';
            playButton.dataset.startTime = utterance.startTime;
            playButton.dataset.endTime = utterance.endTime;
            playButton.dataset.speakerId = speakerId;
            playButton.title = 'Play this segment';
            playButton.addEventListener('click', function() {
                playAudioSegment(this);
            });

            utteranceItem.appendChild(timeElement);
            utteranceItem.appendChild(textElement);
            utteranceItem.appendChild(playButton);

            return utteranceItem;
        }

        // Êí≠ÊîæÈü≥È¢ëÁâáÊÆµ
        function playAudioSegment(button) {
            const startTime = button.dataset.startTime;
            const endTime = button.dataset.endTime;
            const speakerId = button.dataset.speakerId;

            // Ëé∑ÂèñÂΩìÂâçË°®ÂçïÊï∞ÊçÆ‰ª•ÊûÑÂª∫Èü≥È¢ëURL
            const form = document.getElementById('workflowForm');
            const startTimeInput = form.querySelector('input[name="start_time"]').value;
            const endTimeInput = form.querySelector('input[name="end_time"]').value;
            const folderPath = document.getElementById('workflowFolderPath').value;

            // ËΩ¨Êç¢Êó∂Èó¥‰∏∫ÁßíÊï∞ÔºåÁî®‰∫éÂÆö‰ΩçÈü≥È¢ë
            const startSeconds = timeToSeconds(startTime);
            const endSeconds = timeToSeconds(endTime);

            // ÊûÑÈÄ†ÂîØ‰∏ÄID
            const playerId = `player-${speakerId}-${startSeconds}-${endSeconds}`;

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÊí≠ÊîæÂô®
            const parentElement = button.parentElement;
            let audioPlayer = parentElement.querySelector('.audio-player');

            if (audioPlayer) {
                // Â∑≤ÊúâÊí≠ÊîæÂô®ÔºåÂàáÊç¢ÊòæÁ§∫/ÈöêËóè
                if (audioPlayer.style.display === 'none') {
                    audioPlayer.style.display = 'block';

                    // Â¶ÇÊûúÂ∑≤ÁªèÂä†ËΩΩËøáÔºåÁõ¥Êé•Êí≠Êîæ
                    if (audioPlayers[playerId]) {
                        audioPlayers[playerId].play();
                    }
                } else {
                    audioPlayer.style.display = 'none';

                    // ÊöÇÂÅúÊí≠Êîæ
                    if (audioPlayers[playerId]) {
                        audioPlayers[playerId].pause();
                    }
                }
                return;
            }

            // ÂàõÂª∫Êñ∞ÁöÑÈü≥È¢ëÊí≠ÊîæÂô®
            audioPlayer = document.createElement('audio');
            audioPlayer.className = 'audio-player';
            audioPlayer.controls = true;
            audioPlayer.id = playerId;
            parentElement.appendChild(audioPlayer);

            // ÊûÑÂª∫Ëé∑ÂèñÈü≥È¢ëÁâáÊÆµÁöÑURL
            const formData = new FormData();
            formData.set('start_time', isUTC ? startTimeInput : toUTCString(startTimeInput));
            formData.set('end_time', isUTC ? endTimeInput : toUTCString(endTimeInput));
            if (folderPath) {
                formData.set('folder_path', folderPath);
            }
            formData.set('segment_start', startSeconds.toString());
            formData.set('segment_end', endSeconds.toString());

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            button.innerHTML = '‚è≥';
            button.disabled = true;

            // ËØ∑Ê±ÇÈü≥È¢ëÁâáÊÆµ
            fetch('/download_segment', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                audioPlayer.src = url;
                audioPlayer.onended = () => {
                    // Êí≠ÊîæÁªìÊùüÂêéÔºåÊÅ¢Â§çÊí≠ÊîæÊåâÈíÆ
                    button.innerHTML = '‚ñ∂';
                };
                audioPlayer.onplay = () => {
                    button.innerHTML = '‚è∏';
                };
                audioPlayer.onpause = () => {
                    button.innerHTML = '‚ñ∂';
                };

                // Â≠òÂÇ®Êí≠ÊîæÂô®ÂºïÁî®
                audioPlayers[playerId] = audioPlayer;

                // ÂêØÁî®ÊåâÈíÆ
                button.disabled = false;

                // Ëá™Âä®Êí≠Êîæ
                audioPlayer.play();
            })
            .catch(error => {
                console.error('Error fetching audio segment:', error);
                button.innerHTML = '‚ùå';
                button.disabled = false;

                // ÁßªÈô§Êí≠ÊîæÂô®
                audioPlayer.remove();
            });
        }

        // Â∞ÜÊó∂Èó¥Â≠óÁ¨¶‰∏≤ËΩ¨Êç¢‰∏∫ÁßíÊï∞
        function timeToSeconds(timeStr) {
            const parts = timeStr.split(':');
            const seconds = parts.length > 2 ?
                parseFloat(parts[0]) * 3600 + parseFloat(parts[1]) * 60 + parseFloat(parts[2]) :
                parseFloat(parts[0]) * 60 + parseFloat(parts[1]);
            return seconds;
        }

        // ‰øùÂ≠òËØ¥ËØù‰∫∫ÂêçÁß∞Âπ∂Êõ¥Êñ∞ËΩ¨ÂΩïÊñáÊú¨
        function saveSpeakerNames() {
            const nameInputs = document.querySelectorAll('.speaker-name-input');
            const transcript = document.getElementById('transcribeTextarea');
            let updatedText = transcript.value;

            // Êî∂ÈõÜÊâÄÊúâËØ¥ËØù‰∫∫ÂêçÁß∞
            nameInputs.forEach(input => {
                const speakerId = input.dataset.speakerId;
                const speakerName = input.value.trim();

                if (speakerName) {
                    // Êõ¥Êñ∞Êï∞ÊçÆ
                    speakersData[speakerId].name = speakerName;

                    // Êõ¥Êñ∞ËΩ¨ÂΩïÊñáÊú¨
                    const regex = new RegExp(`\\[${speakerId}\\]`, 'g');
                    updatedText = updatedText.replace(regex, `[${speakerName}]`);
                }
            });

            // Êõ¥Êñ∞ËΩ¨ÂΩïÊñáÊú¨
            transcript.value = updatedText;

            // ÂÖ≥Èó≠ÂºπÁ™ó
            speakerModal.style.display = 'none';
        }

        // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨
        if (editSpeakersBtn) {
            editSpeakersBtn.addEventListener('click', openSpeakerModal);
        }

        if (closeSpeakerModal) {
            closeSpeakerModal.addEventListener('click', function() {
                speakerModal.style.display = 'none';
            });
        }

        if (saveSpeakersBtn) {
            saveSpeakersBtn.addEventListener('click', saveSpeakerNames);
        }

        // ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠ÂºπÁ™ó
        window.addEventListener('click', function(event) {
            if (event.target === speakerModal) {
                speakerModal.style.display = 'none';
            }
        });

        // ‰øÆÊîπËΩ¨ÂΩïÂÆåÊàêÂ§ÑÁêÜÔºåÊ∑ªÂä†ÁºñËæëËØ¥ËØù‰∫∫ÊåâÈíÆÁöÑÊòæÁ§∫
        const originalSocketHandler = window.onload;
        window.onload = function() {
            if (typeof originalSocketHandler === 'function') {
                originalSocketHandler();
            }

            // Âú®ËΩ¨ÂΩïÂÆåÊàêÊó∂ÊòæÁ§∫ÁºñËæëËØ¥ËØù‰∫∫ÊåâÈíÆ
            const socket = io();
            socket.on('workflow_progress', function(msg) {
                if (msg && msg.step === 'done') {
                    // ËΩ¨ÂΩïÂÆåÊàêÂêéÔºåÁ°Æ‰øùÁºñËæëËØ¥ËØù‰∫∫ÊåâÈíÆÂèØËßÅ
                    if (document.getElementById('editSpeakersBtn')) {
                        document.getElementById('editSpeakersBtn').style.display = 'inline-block';
                    }
                }
            });
        };
    });
</script>
</body>
</html>
