<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Settings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 40px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 40px;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .back-btn {
            display: inline-block;
            margin-top: 15px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .section:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .section-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        input[type="text"],
        input[type="password"],
        input[type="url"],
        textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="url"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 30px;
        }

        .success-message {
            background: rgba(39, 174, 96, 0.2);
            border-left: 4px solid #27ae60;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.2);
            border-left: 4px solid #e74c3c;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
        }

        /* Â∑•‰ΩúÊµÅÁÆ°ÁêÜÊ†∑Âºè */
        .workflows-container {
            margin-top: 30px;
        }

        .workflow-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .workflow-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }

        .workflow-item:hover {
            border-color: rgba(102, 126, 234, 0.3);
        }

        .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .workflow-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #fff;
        }

        .workflow-actions {
            display: flex;
            gap: 10px;
        }

        .workflow-action-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .workflow-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .workflow-action-btn.edit:hover {
            background: rgba(52, 152, 219, 0.4);
        }

        .workflow-action-btn.delete:hover {
            background: rgba(231, 76, 60, 0.4);
        }

        .workflow-details {
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        .workflow-detail {
            margin-bottom: 5px;
        }

        .workflow-detail span {
            color: #e0e0e0;
        }

        /* Ê∑ªÂä†Â∑•‰ΩúÊµÅË°®Âçï */
        .add-workflow-form {
            margin-top: 30px;
            display: none;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loader {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ÊêúÁ¥¢Ê°Ü‰∏ãÊãâËèúÂçïÊ†∑Âºè */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding-right: 40px; /* ‰∏∫‰∏ãÊãâÁÆ≠Â§¥ÁïôÁ©∫Èó¥ */
        }

        .dropdown-arrow {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: #1f1f3f;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 5px;
            z-index: 1000;
            display: none;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .dropdown-list.show {
            display: block;
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 768px) {
            .section {
                padding: 20px;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Configuration Settings</h1>
        <a href="/" class="back-btn">‚Üê Back to Main Page</a>
    </header>

    <div class="section">
        <div class="section-header">
            <div class="section-icon">üéôÔ∏è</div>
            <h2>Whisper API Settings</h2>
        </div>

        <form id="whisperApiForm">
            <div class="form-group">
                <label for="whisperApiUrl">Whisper API URL</label>
                <input type="url" id="whisperApiUrl" name="whisper_api_url"
                       placeholder="https://whisper.gaia.domains/v1/audio/transcriptions">
            </div>

            <div class="form-group">
                <label for="whisperApiKey">API Key</label>
                <input type="password" id="whisperApiKey" name="whisper_api_key"
                       placeholder="Enter your Whisper API key">
            </div>

            <div class="form-group">
                <label for="whisperApiModel">Model</label>
                <div class="search-container">
                    <input type="text" id="whisperApiModel" name="whisper_api_model"
                           placeholder="Select or type model name" class="search-input">
                    <span class="dropdown-arrow">‚ñº</span>
                    <div id="modelDropdown" class="dropdown-list">
                        <!-- Models will be loaded here -->
                        <div class="dropdown-item">Loading models...</div>
                    </div>
                </div>
            </div>

            <div class="btn-container">
                <button type="submit" class="btn" id="saveWhisperApiBtn">Save Settings</button>
                <button type="button" class="btn" id="fetchModelsBtn"
                        style="background:linear-gradient(135deg, #3498db 0%, #2980b9 100%);">Fetch Models
                </button>
                <div class="loader" id="whisperApiLoader"></div>
            </div>
            <div id="whisperApiSuccess" class="success-message">Settings saved successfully!</div>
            <div id="whisperApiError" class="error-message">Error saving settings.</div>
        </form>
    </div>

    <div class="section">
        <div class="section-header">
            <div class="section-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">üîÑ</div>
            <h2>Workflow Management</h2>
        </div>

        <div class="workflows-container" id="workflowsContainer">
            <div class="workflow-list" id="workflowList">
                <!-- Workflow items will be loaded here -->
                <div style="text-align: center; padding: 20px; color: #b0b0b0;">Loading workflows...</div>
            </div>

            <div class="btn-container">
                <button class="btn" id="addWorkflowBtn">Add New Workflow</button>
                <div class="loader" id="workflowsLoader"></div>
            </div>
            <div id="workflowsSuccess" class="success-message">Operation completed successfully!</div>
            <div id="workflowsError" class="error-message">An error occurred.</div>
        </div>

        <!-- Add/Edit Workflow Form -->
        <div class="add-workflow-form" id="workflowForm">
            <h3 style="color: #fff; margin-bottom: 20px;" id="workflowFormTitle">Add New Workflow</h3>

            <div class="form-group">
                <label for="workflowName">Workflow Name</label>
                <input type="text" id="workflowName" name="name" placeholder="Enter a name for this workflow">
            </div>

            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="workflowInputType">Input Type</label>
                        <select id="workflowInputType" name="input_type"
                                style="width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;">
                            <option value="text">Text</option>
                            <option value="audio">Audio</option>
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="workflowApiEndpoint">API Endpoint</label>
                        <input type="url" id="workflowApiEndpoint" name="api_endpoint"
                               placeholder="https://api.example.com/endpoint">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="workflowApiKey">API Key (Optional)</label>
                <input type="password" id="workflowApiKey" name="api_key" placeholder="Enter API key if needed">
            </div>

            <div class="form-group">
                <label for="workflowApiModel">Model (Optional)</label>
                <div class="search-container">
                    <input type="text" id="workflowApiModel" name="api_model"
                           placeholder="Select or type model name" class="search-input">
                    <span class="dropdown-arrow">‚ñº</span>
                    <div id="workflowModelDropdown" class="dropdown-list">
                        <!-- Models will be loaded here -->
                        <div class="dropdown-item">First fetch models...</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="workflowDescription">Description</label>
                <textarea id="workflowDescription" name="description" rows="3"
                          placeholder="Describe what this workflow does"></textarea>
            </div>

            <div class="form-group">
                <label for="workflowCustomPrompt">Custom Prompt (for text workflows)</label>
                <textarea id="workflowCustomPrompt" name="custom_prompt" rows="5"
                          placeholder="Enter a system prompt for text-based workflows"></textarea>
            </div>

            <input type="hidden" id="workflowEditIndex" value="-1">

            <div class="btn-container">
                <button type="button" class="btn" id="saveWorkflowBtn">Save Workflow</button>
                <button type="button" class="btn" id="fetchWorkflowModelsBtn"
                        style="background:linear-gradient(135deg, #3498db 0%, #2980b9 100%);">Fetch Models</button>
                <button type="button" class="btn" id="cancelWorkflowBtn" style="background: rgba(255,255,255,0.1);">
                    Cancel
                </button>
                <div class="loader" id="workflowModelsLoader"></div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Whisper API Ë°®ÂçïÂ§ÑÁêÜ
        const whisperApiForm = document.getElementById('whisperApiForm');
        const whisperApiUrl = document.getElementById('whisperApiUrl');
        const whisperApiKey = document.getElementById('whisperApiKey');
        const whisperApiModel = document.getElementById('whisperApiModel');
        const whisperApiLoader = document.getElementById('whisperApiLoader');
        const whisperApiSuccess = document.getElementById('whisperApiSuccess');
        const whisperApiError = document.getElementById('whisperApiError');
        const fetchModelsBtn = document.getElementById('fetchModelsBtn');
        const modelDropdown = document.getElementById('modelDropdown');

        // ÂàùÂßãÂä†ËΩΩÈÖçÁΩÆ
        loadWhisperApiConfig();

        // Â§ÑÁêÜÊ®°Âûã‰∏ãÊãâÊ°Ü‰∫§‰∫í
        setupModelDropdown();

        // ‰øùÂ≠ò Whisper API ËÆæÁΩÆ
        whisperApiForm.addEventListener('submit', function (e) {
            e.preventDefault();
            saveWhisperApiConfig();
        });

        // Ëé∑ÂèñÊ®°ÂûãÂàóË°®
        fetchModelsBtn.addEventListener('click', function () {
            fetchWhisperModels();
        });

        // Workflow ÁÆ°ÁêÜ
        const workflowList = document.getElementById('workflowList');
        const addWorkflowBtn = document.getElementById('addWorkflowBtn');
        const workflowForm = document.getElementById('workflowForm');
        const saveWorkflowBtn = document.getElementById('saveWorkflowBtn');
        const cancelWorkflowBtn = document.getElementById('cancelWorkflowBtn');
        const workflowsLoader = document.getElementById('workflowsLoader');
        const workflowsSuccess = document.getElementById('workflowsSuccess');
        const workflowsError = document.getElementById('workflowsError');
        const workflowEditIndex = document.getElementById('workflowEditIndex');
        const workflowApiEndpoint = document.getElementById('workflowApiEndpoint');
        const workflowApiKey = document.getElementById('workflowApiKey');
        const workflowApiModel = document.getElementById('workflowApiModel');
        const workflowModelDropdown = document.getElementById('workflowModelDropdown');
        const fetchWorkflowModelsBtn = document.getElementById('fetchWorkflowModelsBtn');
        const workflowModelsLoader = document.getElementById('workflowModelsLoader');

        // ÂàùÂßãÂä†ËΩΩÂ∑•‰ΩúÊµÅ
        loadWorkflows();

        // Ê∑ªÂä†Â∑•‰ΩúÊµÅÊåâÈíÆ
        addWorkflowBtn.addEventListener('click', function () {
            showWorkflowForm();
        });

        // ‰øùÂ≠òÂ∑•‰ΩúÊµÅ
        saveWorkflowBtn.addEventListener('click', function () {
            saveWorkflow();
        });

        // ÂèñÊ∂àÁºñËæëÂ∑•‰ΩúÊµÅ
        cancelWorkflowBtn.addEventListener('click', function () {
            hideWorkflowForm();
        });

        // ËÆæÁΩÆÂ∑•‰ΩúÊµÅÊ®°Âûã‰∏ãÊãâÊ°Ü‰∫§‰∫í
        setupWorkflowModelDropdown();

        // Ëé∑ÂèñÂ∑•‰ΩúÊµÅÊ®°ÂûãÂàóË°®
        fetchWorkflowModelsBtn.addEventListener('click', function () {
            fetchWorkflowModels();
        });

        // ÂáΩÊï∞ÂÆö‰πâ

        function loadWhisperApiConfig() {
            showLoader(whisperApiLoader);
            fetch('/get_config')
                .then(response => response.json())
                .then(data => {
                    const whisperConfig = data.whisper_api || {};
                    whisperApiUrl.value = whisperConfig.url || '';
                    whisperApiKey.value = whisperConfig.api_key || '';
                    whisperApiModel.value = whisperConfig.model || '';

                    // Â¶ÇÊûúÊúâURLÂíåKeyÔºåËá™Âä®Â∞ùËØïËé∑ÂèñÊ®°ÂûãÂàóË°®
                    if (whisperConfig.url && whisperConfig.api_key) {
                        fetchWhisperModels(false); // ÈùôÈªòËé∑Âèñ
                    }
                })
                .catch(error => {
                    console.error('Error loading Whisper API config:', error);
                    showError(whisperApiError, 'Failed to load configuration.');
                })
                .finally(() => {
                    hideLoader(whisperApiLoader);
                });
        }

        function saveWhisperApiConfig() {
            showLoader(whisperApiLoader);
            hideMessage(whisperApiSuccess);
            hideMessage(whisperApiError);

            const updatedConfig = {
                whisper_api: {
                    url: whisperApiUrl.value.trim() || 'https://whisper.gaia.domains/v1/audio/transcriptions',
                    api_key: whisperApiKey.value.trim(),
                    model: whisperApiModel.value.trim()
                }
            };

            fetch('/update_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedConfig)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        showMessage(whisperApiSuccess, 'Settings saved successfully!');
                        setTimeout(() => hideMessage(whisperApiSuccess), 3000);
                    } else {
                        showError(whisperApiError, 'Failed to save settings: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error saving Whisper API config:', error);
                    showError(whisperApiError, 'An error occurred while saving settings.');
                })
                .finally(() => {
                    hideLoader(whisperApiLoader);
                });
        }

        function fetchWhisperModels(showFeedback = true) {
            if (showFeedback) {
                showLoader(whisperApiLoader);
                hideMessage(whisperApiSuccess);
                hideMessage(whisperApiError);
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊúâURLÂíåAPI Key
            if (!whisperApiUrl.value.trim()) {
                if (showFeedback) {
                    showError(whisperApiError, 'Please enter Whisper API URL first.');
                    hideLoader(whisperApiLoader);
                }
                return;
            }

            fetch('/get_whisper_models', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: whisperApiUrl.value.trim(),
                    api_key: whisperApiKey.value.trim()
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        if (showFeedback) {
                            showError(whisperApiError, 'Failed to fetch models: ' + data.error);
                        }
                        return;
                    }

                    // Êõ¥Êñ∞‰∏ãÊãâÂàóË°®
                    updateModelDropdown(data.models || []);

                    if (showFeedback) {
                        showMessage(whisperApiSuccess, `Successfully fetched ${data.models.length} models.`);
                        setTimeout(() => hideMessage(whisperApiSuccess), 3000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching models:', error);
                    if (showFeedback) {
                        showError(whisperApiError, 'Failed to fetch models: ' + error.message);
                    }
                })
                .finally(() => {
                    if (showFeedback) {
                        hideLoader(whisperApiLoader);
                    }
                });
        }

        function updateModelDropdown(models) {
            modelDropdown.innerHTML = '';

            if (models.length === 0) {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = 'No models found';
                modelDropdown.appendChild(item);
                return;
            }

            models.forEach(model => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = model;
                item.addEventListener('click', () => {
                    whisperApiModel.value = model;
                    hideDropdown();
                });
                modelDropdown.appendChild(item);
            });
        }

        function filterModelDropdown() {
            const filter = whisperApiModel.value.toLowerCase();
            const items = modelDropdown.getElementsByClassName('dropdown-item');

            let hasVisibleItems = false;

            for (let i = 0; i < items.length; i++) {
                const text = items[i].textContent.toLowerCase();
                if (text.includes(filter)) {
                    items[i].style.display = '';
                    hasVisibleItems = true;
                } else {
                    items[i].style.display = 'none';
                }
            }

            if (!hasVisibleItems && items.length > 0) {
                // Ê≤°ÊúâÂåπÈÖçÈ°πÔºåÊòæÁ§∫"Êó†ÂåπÈÖç"Ê∂àÊÅØ
                if (modelDropdown.querySelector('.no-match') === null) {
                    const noMatch = document.createElement('div');
                    noMatch.className = 'dropdown-item no-match';
                    noMatch.textContent = 'No matching models';
                    modelDropdown.appendChild(noMatch);
                }
            } else {
                // ÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑ"Êó†ÂåπÈÖç"Ê∂àÊÅØ
                const noMatch = modelDropdown.querySelector('.no-match');
                if (noMatch) {
                    noMatch.remove();
                }
            }
        }

        function setupModelDropdown() {
            // ÁÇπÂáªËæìÂÖ•Ê°ÜÊòæÁ§∫‰∏ãÊãâÊ°Ü
            whisperApiModel.addEventListener('click', () => {
                showDropdown();
            });

            // ËæìÂÖ•Êó∂ËøáÊª§‰∏ãÊãâÊ°Ü
            whisperApiModel.addEventListener('input', () => {
                if (!modelDropdown.classList.contains('show')) {
                    showDropdown();
                }
                filterModelDropdown();
            });

            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÊó∂ÈöêËóè‰∏ãÊãâÊ°Ü
            document.addEventListener('click', (e) => {
                if (!whisperApiModel.contains(e.target) && !modelDropdown.contains(e.target)) {
                    hideDropdown();
                }
            });

            // ÈîÆÁõò‰∫ã‰ª∂Â§ÑÁêÜ
            whisperApiModel.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideDropdown();
                }
            });
        }

        function showDropdown() {
            modelDropdown.classList.add('show');
        }

        function hideDropdown() {
            modelDropdown.classList.remove('show');
        }

        function loadWorkflows() {
            showLoader(workflowsLoader);
            fetch('/get_full_config')
                .then(response => response.json())
                .then(data => {
                    renderWorkflows(data.workflows || []);
                })
                .catch(error => {
                    console.error('Error loading workflows:', error);
                    showError(workflowsError, 'Failed to load workflows.');
                })
                .finally(() => {
                    hideLoader(workflowsLoader);
                });
        }

        function renderWorkflows(workflows) {
            workflowList.innerHTML = '';
            if (workflows.length === 0) {
                workflowList.innerHTML = '<div style="text-align: center; padding: 20px; color: #b0b0b0;">No workflows configured.</div>';
                return;
            }

            workflows.forEach((workflow, index) => {
                const workflowItem = document.createElement('div');
                workflowItem.className = 'workflow-item';
                workflowItem.innerHTML = `
                        <div class="workflow-header">
                            <div class="workflow-title">${escapeHtml(workflow.name)}</div>
                            <div class="workflow-actions">
                                <button class="workflow-action-btn edit" title="Edit" onclick="editWorkflow(${index})">‚úèÔ∏è</button>
                                <button class="workflow-action-btn delete" title="Delete" onclick="deleteWorkflow(${index})">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="workflow-details">
                            <div class="workflow-detail">Type: <span>${workflow.input_type || 'text'}</span></div>
                            <div class="workflow-detail">API Endpoint: <span>${escapeHtml(workflow.api_endpoint || 'Not set')}</span></div>
                            <div class="workflow-detail">Model: <span>${escapeHtml(workflow.api_model || 'Not set')}</span></div>
                            <div class="workflow-detail">Description: <span>${escapeHtml(workflow.description || 'No description')}</span></div>
                        </div>
                    `;
                workflowList.appendChild(workflowItem);
            });
        }

        function showWorkflowForm(workflow = null) {
            // ÊòæÁ§∫Ë°®Âçï
            workflowForm.style.display = 'block';
            document.getElementById('workflowsContainer').style.display = 'none';

            // ËÆæÁΩÆË°®ÂçïÊ†áÈ¢ò
            document.getElementById('workflowFormTitle').textContent = workflow ? 'Edit Workflow' : 'Add New Workflow';

            // Â°´ÂÖÖË°®Âçï
            document.getElementById('workflowName').value = workflow ? workflow.name : '';
            document.getElementById('workflowInputType').value = workflow ? (workflow.input_type || 'text') : 'text';
            document.getElementById('workflowApiEndpoint').value = workflow ? (workflow.api_endpoint || '') : '';
            document.getElementById('workflowApiKey').value = workflow ? (workflow.api_key || '') : '';
            document.getElementById('workflowApiModel').value = workflow ? (workflow.api_model || '') : '';
            document.getElementById('workflowDescription').value = workflow ? (workflow.description || '') : '';
            document.getElementById('workflowCustomPrompt').value = workflow ? (workflow.custom_prompt || '') : '';

            // ËÆæÁΩÆÁºñËæëÁ¥¢Âºï
            document.getElementById('workflowEditIndex').value = workflow ? workflow.index : -1;

            // Â¶ÇÊûúÊúâAPIÁ´ØÁÇπÂíåÂØÜÈí•ÔºåËá™Âä®Â∞ùËØïËé∑ÂèñÊ®°ÂûãÂàóË°®
            if (workflow && workflow.api_endpoint && workflow.api_key) {
                fetchWorkflowModels(false); // ÈùôÈªòËé∑Âèñ
            }
        }

        function hideWorkflowForm() {
            workflowForm.style.display = 'none';
            document.getElementById('workflowsContainer').style.display = 'block';
        }

        function saveWorkflow() {
            showLoader(workflowsLoader);
            hideMessage(workflowsSuccess);
            hideMessage(workflowsError);

            // Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
            const name = document.getElementById('workflowName').value.trim();
            const inputType = document.getElementById('workflowInputType').value;
            const apiEndpoint = document.getElementById('workflowApiEndpoint').value.trim();
            const apiKey = document.getElementById('workflowApiKey').value.trim();
            const apiModel = document.getElementById('workflowApiModel').value.trim();
            const description = document.getElementById('workflowDescription').value.trim();
            const customPrompt = document.getElementById('workflowCustomPrompt').value.trim();
            const editIndex = parseInt(document.getElementById('workflowEditIndex').value);

            // È™åËØÅ
            if (!name) {
                showError(workflowsError, 'Workflow name is required.');
                hideLoader(workflowsLoader);
                return;
            }

            // ÊûÑÂª∫Â∑•‰ΩúÊµÅÂØπË±°
            const workflow = {
                name,
                input_type: inputType,
                api_endpoint: apiEndpoint,
                api_key: apiKey,
                api_model: apiModel,
                description,
                custom_prompt: customPrompt
            };

            // Ëé∑ÂèñÁé∞ÊúâÈÖçÁΩÆ
            fetch('/get_full_config')
                .then(response => response.json())
                .then(config => {
                    const workflows = config.workflows || [];

                    if (editIndex >= 0) {
                        // ÁºñËæëÁé∞ÊúâÂ∑•‰ΩúÊµÅ
                        workflows[editIndex] = workflow;
                    } else {
                        // Ê∑ªÂä†Êñ∞Â∑•‰ΩúÊµÅ
                        workflows.push(workflow);
                    }

                    // Êõ¥Êñ∞ÈÖçÁΩÆ
                    config.workflows = workflows;
                    return fetch('/update_full_config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(config)
                    });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        loadWorkflows(); // ÈáçÊñ∞Âä†ËΩΩÂ∑•‰ΩúÊµÅÂàóË°®
                        hideWorkflowForm();
                        showMessage(workflowsSuccess, 'Workflow saved successfully!');
                        setTimeout(() => hideMessage(workflowsSuccess), 3000);
                    } else {
                        showError(workflowsError, 'Failed to save workflow: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error saving workflow:', error);
                    showError(workflowsError, 'An error occurred while saving the workflow.');
                })
                .finally(() => {
                    hideLoader(workflowsLoader);
                });
        }

        function fetchWorkflowModels(showFeedback = true) {
            if (showFeedback) {
                showLoader(workflowModelsLoader);
                hideMessage(workflowsSuccess);
                hideMessage(workflowsError);
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊúâURLÂíåAPI Key
            if (!workflowApiEndpoint.value.trim()) {
                if (showFeedback) {
                    showError(workflowsError, 'Please enter API Endpoint first.');
                    hideLoader(workflowModelsLoader);
                }
                return;
            }

            fetch('/get_api_models', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: workflowApiEndpoint.value.trim(),
                    api_key: workflowApiKey.value.trim()
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        if (showFeedback) {
                            showError(workflowsError, 'Failed to fetch models: ' + data.error);
                        }
                        return;
                    }

                    // Êõ¥Êñ∞‰∏ãÊãâÂàóË°®
                    updateWorkflowModelDropdown(data.models || []);

                    if (showFeedback) {
                        showMessage(workflowsSuccess, `Successfully fetched ${data.models.length} models.`);
                        setTimeout(() => hideMessage(workflowsSuccess), 3000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching models:', error);
                    if (showFeedback) {
                        showError(workflowsError, 'Failed to fetch models: ' + error.message);
                    }
                })
                .finally(() => {
                    if (showFeedback) {
                        hideLoader(workflowModelsLoader);
                    }
                });
        }

        function updateWorkflowModelDropdown(models) {
            workflowModelDropdown.innerHTML = '';

            if (models.length === 0) {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = 'No models found';
                workflowModelDropdown.appendChild(item);
                return;
            }

            models.forEach(model => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = model;
                item.addEventListener('click', () => {
                    workflowApiModel.value = model;
                    hideWorkflowDropdown();
                });
                workflowModelDropdown.appendChild(item);
            });
        }

        function filterWorkflowModelDropdown() {
            const filter = workflowApiModel.value.toLowerCase();
            const items = workflowModelDropdown.getElementsByClassName('dropdown-item');

            let hasVisibleItems = false;

            for (let i = 0; i < items.length; i++) {
                const text = items[i].textContent.toLowerCase();
                if (text.includes(filter)) {
                    items[i].style.display = '';
                    hasVisibleItems = true;
                } else {
                    items[i].style.display = 'none';
                }
            }

            if (!hasVisibleItems && items.length > 0) {
                // Ê≤°ÊúâÂåπÈÖçÈ°πÔºåÊòæÁ§∫"Êó†ÂåπÈÖç"Ê∂àÊÅØ
                if (workflowModelDropdown.querySelector('.no-match') === null) {
                    const noMatch = document.createElement('div');
                    noMatch.className = 'dropdown-item no-match';
                    noMatch.textContent = 'No matching models';
                    workflowModelDropdown.appendChild(noMatch);
                }
            } else {
                // ÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑ"Êó†ÂåπÈÖç"Ê∂àÊÅØ
                const noMatch = workflowModelDropdown.querySelector('.no-match');
                if (noMatch) {
                    noMatch.remove();
                }
            }
        }

        function setupWorkflowModelDropdown() {
            // ÁÇπÂáªËæìÂÖ•Ê°ÜÊòæÁ§∫‰∏ãÊãâÊ°Ü
            workflowApiModel.addEventListener('click', () => {
                showWorkflowDropdown();
            });

            // ËæìÂÖ•Êó∂ËøáÊª§‰∏ãÊãâÊ°Ü
            workflowApiModel.addEventListener('input', () => {
                if (!workflowModelDropdown.classList.contains('show')) {
                    showWorkflowDropdown();
                }
                filterWorkflowModelDropdown();
            });

            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÊó∂ÈöêËóè‰∏ãÊãâÊ°Ü
            document.addEventListener('click', (e) => {
                if (!workflowApiModel.contains(e.target) && !workflowModelDropdown.contains(e.target)) {
                    hideWorkflowDropdown();
                }
            });

            // ÈîÆÁõò‰∫ã‰ª∂Â§ÑÁêÜ
            workflowApiModel.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideWorkflowDropdown();
                }
            });
        }

        function showWorkflowDropdown() {
            workflowModelDropdown.classList.add('show');
        }

        function hideWorkflowDropdown() {
            workflowModelDropdown.classList.remove('show');
        }

        // Â∑•‰ΩúÊµÅÁºñËæëÂíåÂà†Èô§ÂáΩÊï∞Ôºå‰ΩøÁî®ÂÖ®Â±ÄÂáΩÊï∞‰ª•‰æø‰ªéHTML‰∏≠Ë∞ÉÁî®
        window.editWorkflow = function (index) {
            showLoader(workflowsLoader);
            fetch('/get_full_config')
                .then(response => response.json())
                .then(data => {
                    const workflow = data.workflows[index];
                    workflow.index = index; // Ê∑ªÂä†Á¥¢Âºï
                    showWorkflowForm(workflow);
                })
                .catch(error => {
                    console.error('Error loading workflow for edit:', error);
                    showError(workflowsError, 'Failed to load workflow details.');
                })
                .finally(() => {
                    hideLoader(workflowsLoader);
                });
        };

        window.deleteWorkflow = function (index) {
            if (!confirm('Are you sure you want to delete this workflow?')) {
                return;
            }

            showLoader(workflowsLoader);
            fetch('/get_full_config')
                .then(response => response.json())
                .then(config => {
                    // Âà†Èô§ÊåáÂÆöÁ¥¢ÂºïÁöÑÂ∑•‰ΩúÊµÅ
                    config.workflows.splice(index, 1);

                    // Êõ¥Êñ∞ÈÖçÁΩÆ
                    return fetch('/update_full_config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(config)
                    });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        loadWorkflows(); // ÈáçÊñ∞Âä†ËΩΩÂ∑•‰ΩúÊµÅÂàóË°®
                        showMessage(workflowsSuccess, 'Workflow deleted successfully!');
                        setTimeout(() => hideMessage(workflowsSuccess), 3000);
                    } else {
                        showError(workflowsError, 'Failed to delete workflow: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error deleting workflow:', error);
                    showError(workflowsError, 'An error occurred while deleting the workflow.');
                })
                .finally(() => {
                    hideLoader(workflowsLoader);
                });
        };

        // ËæÖÂä©ÂáΩÊï∞
        function showLoader(loader) {
            if (loader) loader.style.display = 'inline-block';
        }

        function hideLoader(loader) {
            if (loader) loader.style.display = 'none';
        }

        function showMessage(element, message) {
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            }
        }

        function hideMessage(element) {
            if (element) {
                element.style.display = 'none';
            }
        }

        function showError(element, message) {
            showMessage(element, message);
            setTimeout(() => hideMessage(element), 5000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    });
</script>
</body>
</html>
